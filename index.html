<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Mapping Config Builder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- JS-YAML for parsing ECS schemas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.8); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }
        textarea:focus, input:focus { outline: none; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Tooltip for validation */
        .tooltip-trigger:hover .tooltip-content { display: block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Helper Functions (Global) ---
        
        // Helper to handle CORS issues by falling back to a proxy with retries
        const fetchWithRetry = async (fn, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        };

        // Helper to read stream and report progress
        const readStreamWithProgress = async (response, onProgress) => {
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            let receivedLength = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                chunks.push(value);
                receivedLength += value.length;
                
                if (onProgress) {
                    onProgress(receivedLength, contentLength);
                }
            }

            let chunksAll = new Uint8Array(receivedLength);
            let position = 0;
            for(let chunk of chunks) {
                chunksAll.set(chunk, position);
                position += chunk.length;
            }

            return new TextDecoder("utf-8").decode(chunksAll);
        };

        // Helper to handle CORS issues by falling back to a proxy
        const fetchRawFile = async (url, onProgress, logMessage) => {
            // Detect GitHub Raw URL and convert to jsDelivr CDN if possible for better stability
            let targetUrl = url;
            if (url.startsWith("https://raw.githubusercontent.com/")) {
                const parts = url.replace("https://raw.githubusercontent.com/", "").split("/");
                const user = parts[0];
                const repo = parts[1];
                const branch = parts[2];
                const path = parts.slice(3).join("/");
                // Use jsDelivr structure: https://cdn.jsdelivr.net/gh/user/repo@branch/path
                targetUrl = `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
            }

            try {
                if (logMessage) logMessage(`Connecting to CDN (${targetUrl})...`);
                // Try direct fetch first (CDN usually supports CORS)
                const res = await fetch(targetUrl);
                if (res.ok) {
                    return await readStreamWithProgress(res, onProgress);
                }
                throw new Error(`Direct fetch failed: ${res.status}`);
            } catch (err) {
                if (logMessage) logMessage(`Direct connection failed. Switching to Proxy... (${err.message})`);
                
                // Fallback to proxy with original URL if CDN fails
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                return await fetchWithRetry(async () => {
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error(`Proxy Error: ${res.status}`);
                    return await readStreamWithProgress(res, onProgress);
                }, 3, 1500); 
            }
        };

        // --- ECS Reference Data (Fallback) ---
        const ECS_NON_KEYWORD_FIELDS = {
            "@timestamp": "date", "event.created": "date", "source.ip": "ip", "source.port": "long" 
        };

        const validateEcsType = (value, type) => {
            if (value === undefined || value === null || value === "") return true; 
            const strVal = String(value).trim();
            switch (type) {
                case 'ip': return /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(strVal) || strVal.includes(':');
                case 'long': case 'integer': return /^-?\d+$/.test(strVal) && !isNaN(parseInt(strVal));
                case 'float': return !isNaN(parseFloat(strVal));
                case 'boolean': return /^(true|false|0|1)$/i.test(strVal);
                case 'date': return !isNaN(Date.parse(strVal)) || /^\d+$/.test(strVal) || (strVal.includes('-') && strVal.includes(':'));
                case 'geo_point': if (typeof rawVal === 'object') return ('lat' in rawVal && 'lon' in rawVal); return strVal.includes(',') || strVal.includes('[');
                default: return true;
            }
        };

        const Icon = ({ path, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Code: <path d="m18 16 4-4-4-4M6 8l-4 4 4 4m6-8-4 8"/>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>,
            ArrowRight: <path d="M5 12h14M12 5l7 7-7 7"/>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            Check: <path d="M20 6 9 17l-5-5"/>,
            Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
            EyeOff: <><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>,
            Sliders: <><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="1" x2="7" y1="14" y2="14"/><line x1="9" x2="15" y1="8" y2="8"/><line x1="17" x2="23" y1="16" y2="16"/></>,
            ArrowRightLeft: <><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></>,
            Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
            CornerDownRight: <><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></>,
            Trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>,
            SortAsc: <><path d="M11 5h10"/><path d="M11 9h7"/><path d="M11 13h4"/><path d="M3 17l3 3 3-3"/><path d="M6 18V4"/></>,
            List: <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            Flag: <><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
            Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            Unlock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>,
            Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></>,
            FilePlus: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" x2="12" y1="18" y2="12"/><line x1="9" x2="15" y1="15" y2="15"/></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></>,
            History: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M12 7v5l4 2" /></>,
            Play: <polygon points="5 3 19 12 5 21 5 3" />,
            RefreshCw: <><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>,
            AlertTriangle: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>,
            Info: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="16" y2="12" /><line x1="12" x2="12.01" y1="8" y2="8" /></>,
            Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            Database: <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>,
            Globe: <><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>,
            Filter: <><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>,
            ChevronDown: <polyline points="6 9 12 15 18 9" />,
            ChevronRight: <polyline points="9 18 15 12 9 6" />,
            ClipboardCheck: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></>,
            Wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>,
            WifiOff: <><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>
        };

        const SimpleIcon = ({ name, size, className }) => (
            <Icon path={Icons[name] || Icons.Code} size={size} className={className} />
        );

        // --- Helpers ---
        const findTempObject = (obj) => {
            if (!obj || typeof obj !== 'object') return null;
            if (Array.isArray(obj)) return null;
            if ('_temp' in obj) return obj['_temp'];
            for (const key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    const found = findTempObject(obj[key]);
                    if (found) return found;
                }
            }
            return null;
        };

        const extractKeys = (obj, prefix = '') => {
            let keys = [];
            for (const key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                    keys = keys.concat(extractKeys(obj[key], prefix ? `${prefix}.${key}` : key));
                } else {
                    keys.push({ fullPath: prefix ? `${prefix}.${key}` : key, name: key, sampleValue: obj[key] });
                }
            }
            return keys;
        };

        const flattenObjectKeys = (obj, prefix = '') => {
            let keys = [];
            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const path = prefix ? `${prefix}.${key}` : key;
                    keys.push(path);
                    if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                        keys = keys.concat(flattenObjectKeys(obj[key], path));
                    }
                }
            }
            return keys;
        };

        const parseExcelTSV = (text) => {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++; 
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === '\t' && !inQuotes) {
                    currentRow.push(currentCell);
                    currentCell = '';
                } else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentCell);
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                rows.push(currentRow);
            }
            return rows;
        };

        // --- Local Storage Hook ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        const useStickyMapState = (key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? new Map(JSON.parse(stickyValue)) : new Map();
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(Array.from(value.entries())));
            }, [key, value]);
            return [value, setValue];
        };

        // --- Components ---
        // ... ConversionEditor (Keep existing) ...
        const ConversionEditor = ({ conversions, onAdd, onRemove, onEdit, placeholderPrefix }) => {
            const [newFrom, setNewFrom] = useState("");
            const [newTo, setNewTo] = useState("");
            const [editingIdx, setEditingIdx] = useState(null);
            const [editFrom, setEditFrom] = useState("");
            const [editTo, setEditTo] = useState("");
            const toInputRef = useRef(null);

            const handleAdd = () => { if (newFrom && newTo) { onAdd(newFrom, newTo); setNewFrom(""); setNewTo(""); } };
            const handleAddDefault = () => { setNewFrom("default"); setNewTo(""); if (toInputRef.current) toInputRef.current.focus(); };

            const startEdit = (idx, from, to) => {
                setEditingIdx(idx);
                setEditFrom(from);
                setEditTo(to);
            };

            const saveEdit = () => {
                if (editFrom && editTo) {
                    onEdit(editingIdx, editFrom, editTo);
                    setEditingIdx(null);
                }
            };

            const sortedConversions = useMemo(() => {
                if (!conversions) return [];
                const withIndex = conversions.map((c, i) => ({ ...c, idx: i }));
                const defaults = withIndex.filter(c => c.from === 'default');
                const others = withIndex.filter(c => c.from !== 'default');
                return [...others, ...defaults];
            }, [conversions]);

            return (
                <div className="space-y-2 pl-8"> 
                    <div className="text-[10px] text-amber-500 font-semibold mb-1">VALUE CONVERSIONS</div>
                    {sortedConversions.map((c) => (
                        <div key={c.idx} className="flex items-center gap-2 text-xs">
                            {editingIdx === c.idx ? (
                                <>
                                    <div className="flex-1 min-w-0"><input value={editFrom} onChange={(e) => setEditFrom(e.target.value)} className="w-full bg-slate-800 border border-blue-500 rounded px-2 py-1 text-xs outline-none" placeholder="From" /></div>
                                    <SimpleIcon name="ArrowRight" size={10} className="text-slate-600" />
                                    <div className="flex-1 min-w-0"><input value={editTo} onChange={(e) => setEditTo(e.target.value)} className="w-full bg-slate-800 border border-blue-500 rounded px-2 py-1 text-xs outline-none" placeholder="To" /></div>
                                    <button onClick={saveEdit} className="text-emerald-500 hover:text-emerald-400 p-1"><SimpleIcon name="Check" size={14} /></button>
                                    <button onClick={() => setEditingIdx(null)} className="text-slate-500 hover:text-slate-400 p-1"><SimpleIcon name="X" size={14} /></button>
                                </>
                            ) : (
                                <>
                                    <div className={`flex-1 border rounded px-2 py-1 text-center truncate ${c.from === 'default' ? 'bg-amber-900/20 border-amber-700/50 text-amber-500 font-bold tracking-wider' : 'bg-slate-950 border-slate-700 text-slate-300'}`}>
                                        {c.from === 'default' ? 'DEFAULT' : c.from}
                                    </div>
                                    <SimpleIcon name="ArrowRight" size={10} className="text-slate-600" />
                                    <div className="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-emerald-300 text-center truncate">{c.to}</div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => startEdit(c.idx, c.from, c.to)} className="text-slate-500 hover:text-blue-400 p-1"><SimpleIcon name="Edit" size={12} /></button>
                                        <button onClick={() => onRemove(c.idx)} className="text-slate-500 hover:text-red-400 p-1"><SimpleIcon name="Trash" size={12} /></button>
                                    </div>
                                </>
                            )}
                        </div>
                    ))}
                    <div className="flex items-center gap-2 bg-slate-900/50 p-1 rounded border border-slate-700/50">
                        <div className="flex-1 min-w-0 relative"><input value={newFrom} onChange={(e) => setNewFrom(e.target.value)} placeholder="From" className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs focus:border-amber-500 outline-none" /></div>
                        <SimpleIcon name="ArrowRight" size={10} className="text-slate-500" />
                        <input ref={toInputRef} value={newTo} onChange={(e) => setNewTo(e.target.value)} placeholder="To" className="flex-1 min-w-0 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs focus:border-amber-500 outline-none" onKeyDown={(e) => { if (e.key === 'Enter') handleAdd(); }} />
                        <button onClick={handleAddDefault} className="p-1 px-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 text-amber-500 text-[10px] rounded transition-colors" title="Set Default">Def</button>
                        <button onClick={handleAdd} className="p-1 bg-slate-700 hover:bg-amber-600 hover:text-white text-slate-300 rounded transition-colors"><SimpleIcon name="Plus" size={12} /></button>
                    </div>
                </div>
            );
        };

        // ... CoverageChecker (Keep existing) ...
        const CoverageChecker = ({ mergedKeys, mappings, extraMappings, moduleName, ignoreList, excludedKeys }) => {
            const [requirementsStr, setRequirementsStr] = useStickyState("@timestamp\nevent.kind\nevent.category\nevent.type\nevent.outcome", 'jcb_coverage_reqs');
            const [validationJson, setValidationJson] = useStickyState("", 'jcb_coverage_validation_json');
            const [filterStatus, setFilterStatus] = useState('all'); 

            const actualOutputFields = useMemo(() => {
                if (!validationJson.trim()) return new Set();
                try {
                    const parsed = JSON.parse(validationJson);
                    let source = parsed;
                    
                    // Handle common Elasticsearch formats strategy
                    if (parsed._source) {
                        // Direct document source
                        source = parsed._source;
                    } else if (parsed.hits && parsed.hits.hits && Array.isArray(parsed.hits.hits) && parsed.hits.hits.length > 0 && parsed.hits.hits[0]._source) {
                        // Search response (hits.hits[0]._source)
                        source = parsed.hits.hits[0]._source;
                    } else if (parsed.docs && Array.isArray(parsed.docs) && parsed.docs.length > 0) {
                        // Ingest Simulate / Mget response
                        // Structure: { "docs": [ { "doc": { "_source": ... } } ] }
                        const docItem = parsed.docs[0];
                        if (docItem.doc && docItem.doc._source) {
                            source = docItem.doc._source;
                        } else if (docItem._source) {
                            source = docItem._source;
                        }
                    }
                    
                    const keys = flattenObjectKeys(source);
                    return new Set(keys);
                } catch (e) {
                    console.warn("Validation JSON parse error", e);
                    return new Set();
                }
            }, [validationJson]);

            const currentOutputMap = useMemo(() => {
                const map = new Map(); 
                const prefix = moduleName.trim() || 'user';

                mergedKeys.forEach(k => {
                    if (ignoreList.includes(k.name) || excludedKeys[k.name]) return;

                    const userDefined = mappings[k.name];
                    const target = userDefined !== undefined ? userDefined : `${prefix}.${k.name}`;
                    
                    if (target) {
                        if (!map.has(target)) map.set(target, []);
                        map.get(target).push(k.name);
                    }

                    if (extraMappings[k.name]) {
                        extraMappings[k.name].forEach(extra => {
                            if (extra.path) {
                                if (!map.has(extra.path)) map.set(extra.path, []);
                                map.get(extra.path).push(`${k.name} (extra)`);
                            }
                        });
                    }
                });
                return map;
            }, [mergedKeys, mappings, extraMappings, moduleName, ignoreList, excludedKeys]);

            const report = useMemo(() => {
                const reqs = requirementsStr.split('\n').map(s => s.trim()).filter(s => s);
                return reqs.map(req => {
                    const sources = currentOutputMap.get(req) || [];
                    const presentInOutput = actualOutputFields.has(req);
                    return {
                        field: req,
                        mapped: sources.length > 0,
                        inOutput: presentInOutput,
                        sources: sources
                    };
                });
            }, [requirementsStr, currentOutputMap, actualOutputFields]);

            const filteredReport = report.filter(r => {
                if (filterStatus === 'missing_config') return !r.mapped;
                if (filterStatus === 'missing_output') return validationJson && !r.inOutput;
                if (filterStatus === 'found') return r.mapped;
                return true;
            });

            const configProgress = Math.round((report.filter(r => r.mapped).length / (report.length || 1)) * 100);
            const outputProgress = Math.round((report.filter(r => r.inOutput).length / (report.length || 1)) * 100);

            return (
                <div className="flex h-full gap-4">
                    <div className="w-1/4 min-w-[250px] flex flex-col gap-3 bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                        <div className="flex flex-col gap-2 h-1/2">
                            <div className="flex items-center justify-between">
                                <label className="text-xs font-bold text-slate-400 flex items-center gap-2"><SimpleIcon name="List" size={12}/> REQUIRED FIELDS</label>
                                <span className="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded text-slate-300">{report.length}</span>
                            </div>
                            <div className="text-[10px] text-slate-500">Expected ECS fields (one per line).</div>
                            <textarea 
                                value={requirementsStr} 
                                onChange={e => setRequirementsStr(e.target.value)}
                                className="flex-1 w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs font-mono focus:border-blue-500 outline-none resize-none custom-scrollbar"
                                placeholder="event.category&#10;source.ip&#10;..."
                                spellCheck="false"
                            />
                        </div>
                        
                        <div className="h-px bg-slate-700"></div>

                        <div className="flex flex-col gap-2 h-1/2">
                            <div className="flex items-center justify-between">
                                <label className="text-xs font-bold text-slate-400 flex items-center gap-2"><SimpleIcon name="Code" size={12}/> VALIDATION JSON</label>
                                {validationJson && (
                                    <span className={`text-[10px] px-1.5 py-0.5 rounded ${actualOutputFields.size > 0 ? 'bg-emerald-900/30 text-emerald-400' : 'bg-red-900/30 text-red-400'}`}>
                                        {actualOutputFields.size > 0 ? `${actualOutputFields.size} Keys` : 'Invalid'}
                                    </span>
                                )}
                            </div>
                            <div className="text-[10px] text-slate-500">Paste actual Elasticsearch output (e.g. _source).</div>
                            <textarea 
                                value={validationJson} 
                                onChange={e => setValidationJson(e.target.value)}
                                className="flex-1 w-full bg-slate-900 border border-slate-600 rounded p-2 text-[10px] font-mono focus:border-blue-500 outline-none resize-none custom-scrollbar text-slate-400"
                                placeholder='{"docs": [{"doc": {"_source": {"event": ...}}}]}'
                                spellCheck="false"
                            />
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/30 shrink-0">
                            <div className="flex items-center gap-6">
                                <h2 className="text-sm font-bold text-slate-200 flex items-center gap-2">
                                    <SimpleIcon name="ClipboardCheck" className="text-purple-400"/> Analysis
                                </h2>
                                <div className="flex gap-4">
                                    <div className="flex flex-col">
                                        <span className="text-[9px] text-slate-500 uppercase font-bold">Config Coverage</span>
                                        <div className="flex items-center gap-2">
                                            <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                                <div className={`h-full transition-all duration-500 ${configProgress === 100 ? 'bg-blue-500' : 'bg-blue-600/50'}`} style={{ width: `${configProgress}%` }}></div>
                                            </div>
                                            <span className={`text-xs font-bold ${configProgress === 100 ? 'text-blue-400' : 'text-slate-400'}`}>{configProgress}%</span>
                                        </div>
                                    </div>
                                    {validationJson && (
                                        <div className="flex flex-col animate-fade-in">
                                            <span className="text-[9px] text-slate-500 uppercase font-bold">Output Match</span>
                                            <div className="flex items-center gap-2">
                                                <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                                    <div className={`h-full transition-all duration-500 ${outputProgress === 100 ? 'bg-emerald-500' : 'bg-emerald-600/50'}`} style={{ width: `${outputProgress}%` }}></div>
                                                </div>
                                                <span className={`text-xs font-bold ${outputProgress === 100 ? 'text-emerald-400' : 'text-slate-400'}`}>{outputProgress}%</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="flex bg-slate-800 rounded p-0.5 border border-slate-600">
                                <button onClick={() => setFilterStatus('all')} className={`px-3 py-1 text-[10px] rounded transition-colors ${filterStatus === 'all' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-slate-200'}`}>All</button>
                                <button onClick={() => setFilterStatus('found')} className={`px-3 py-1 text-[10px] rounded transition-colors ${filterStatus === 'found' ? 'bg-blue-900/50 text-blue-400' : 'text-slate-400 hover:text-slate-200'}`}>Mapped</button>
                                <button onClick={() => setFilterStatus('missing_config')} className={`px-3 py-1 text-[10px] rounded transition-colors ${filterStatus === 'missing_config' ? 'bg-red-900/50 text-red-400' : 'text-slate-400 hover:text-slate-200'}`}>Unmapped</button>
                                {validationJson && <button onClick={() => setFilterStatus('missing_output')} className={`px-3 py-1 text-[10px] rounded transition-colors ${filterStatus === 'missing_output' ? 'bg-amber-900/50 text-amber-400' : 'text-slate-400 hover:text-slate-200'}`}>Missing in Output</button>}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto custom-scrollbar p-0">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-800 sticky top-0 z-10 text-xs text-slate-400 font-semibold shadow-sm">
                                    <tr>
                                        <th className="p-3 border-b border-slate-700 w-1/3">Required Field</th>
                                        <th className="p-3 border-b border-slate-700 w-24 text-center">Config Status</th>
                                        <th className="p-3 border-b border-slate-700 w-24 text-center">Output Status</th>
                                        <th className="p-3 border-b border-slate-700">Mapped From</th>
                                    </tr>
                                </thead>
                                <tbody className="text-xs">
                                    {filteredReport.map((row, i) => (
                                        <tr key={i} className={`border-b border-slate-800/50 hover:bg-slate-700/20 transition-colors ${!row.mapped ? 'bg-red-900/5' : ''}`}>
                                            <td className="p-3 font-mono text-slate-300">{row.field}</td>
                                            
                                            {/* Config Status */}
                                            <td className="p-3 text-center">
                                                {row.mapped 
                                                    ? <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-900/30 text-blue-400 border border-blue-800 rounded text-[10px] font-bold"><SimpleIcon name="Check" size={10}/> MAPPED</span>
                                                    : <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-red-900/30 text-red-400 border border-red-800 rounded text-[10px] font-bold">MISSING</span>
                                                }
                                            </td>

                                            {/* Output Status */}
                                            <td className="p-3 text-center">
                                                {!validationJson ? (
                                                    <span className="text-slate-600">-</span>
                                                ) : row.inOutput ? (
                                                    <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-emerald-900/30 text-emerald-400 border border-emerald-800 rounded text-[10px] font-bold"><SimpleIcon name="Check" size={10}/> FOUND</span>
                                                ) : (
                                                    <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-900/30 text-amber-400 border border-amber-800 rounded text-[10px] font-bold">ABSENT</span>
                                                )}
                                            </td>

                                            <td className="p-3 text-slate-400">
                                                {row.mapped ? (
                                                    <div className="flex flex-wrap gap-1">
                                                        {row.sources.map((s, idx) => (
                                                            <span key={idx} className="px-1.5 py-0.5 bg-slate-800 rounded border border-slate-700 text-[10px] font-mono">{s}</span>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <span className="text-slate-600 italic">-</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    {filteredReport.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-500 italic">No fields match current filter</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const EcsLibrary = () => {
            // ... (existing code for EcsLibrary) ...
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);
            const [error, setError] = useState(null);
            const [parsedFields, setParsedFields] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [filterLevel, setFilterLevel] = useState('all'); 
            const [expandedField, setExpandedField] = useState(null); 

            useEffect(() => {
                fetchFileList();
            }, []);

            const fetchFileList = async () => {
                setLoading(true);
                try {
                    const res = await fetch("https://api.github.com/repos/elastic/ecs/contents/schemas?ref=main");
                    if (!res.ok) throw new Error(`GitHub API Error: ${res.status}`);
                    const data = await res.json();
                    const ymlFiles = data.filter(f => f.name.endsWith('.yml') && f.type === 'file');
                    setFiles(ymlFiles);
                } catch (e) {
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };

            const processYamlToFields = (parsedYaml) => {
                const flatFields = [];
                const flatten = (obj, prefix = '') => {
                    if (Array.isArray(obj)) {
                        obj.forEach(item => {
                            const currentName = item.name;
                            const currentPath = prefix ? `${prefix}.${currentName}` : currentName;
                            
                            if (item.fields) {
                                flatten(item.fields, currentPath);
                            } else {
                                flatFields.push({
                                    name: currentPath,
                                    type: item.type || 'keyword',
                                    level: item.level || 'custom',
                                    short: item.short || '',
                                    description: item.description || '',
                                    example: item.example || '',
                                    allowed_values: item.allowed_values || null,
                                    normalize: item.normalize || null
                                });
                            }
                        });
                    } else if (typeof obj === 'object') {
                         for (const key in obj) {
                             if (key === 'fields' && Array.isArray(obj[key])) {
                                 flatten(obj[key], prefix);
                             }
                         }
                    }
                };
                
                if (Array.isArray(parsedYaml)) {
                    parsedYaml.forEach(group => {
                        const groupPrefix = group.name; 
                        if (group.fields) {
                            flatten(group.fields, groupPrefix);
                        }
                    });
                } else if (typeof parsedYaml === 'object') {
                     if (parsedYaml.fields) flatten(parsedYaml.fields, parsedYaml.name);
                }
                return flatFields;
            };

            const fetchWithRetry = async (fn, retries = 3, delay = 1000) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        return await fn();
                    } catch (err) {
                        if (i === retries - 1) throw err;
                        await new Promise(r => setTimeout(r, delay));
                    }
                }
            };

            // MODIFIED: Re-use global fetchRawFile if possible, but here for self-containment 
            // we can just call the global one or redefine.
            // Since fetchRawFile is defined globally in the script, we can use it directly.
            
            const fetchSchemaContent = async (file) => {
                setSelectedFile(file);
                setParsedFields([]);
                setLoading(true);
                setFilterLevel('all'); 
                setExpandedField(null); 
                try {
                    const text = await fetchRawFile(file.download_url);
                    const parsed = jsyaml.load(text);
                    const fields = processYamlToFields(parsed);
                    setParsedFields(fields);
                } catch (e) {
                    setError("YAML Parse Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const scanAllCoreFields = async () => {
                if (files.length === 0) return;
                if (!confirm(`⚠️ WARNING: This will make ${files.length} requests to GitHub API.\n\nGitHub limits unauthenticated requests to 60 per hour.\n\nDo you want to proceed scanning for ALL CORE fields?`)) return;

                setLoading(true);
                setSelectedFile({ name: "Global Scan (Core Only)", path: "global_scan" });
                setParsedFields([]);
                setError(null);
                setFilterLevel('core'); 
                setExpandedField(null);

                let allCore = [];
                let failedCount = 0;

                try {
                    const batchSize = 5;
                    for (let i = 0; i < files.length; i += batchSize) {
                        const batch = files.slice(i, i + batchSize);
                        const promises = batch.map(async (file) => {
                            try {
                                const text = await fetchRawFile(file.download_url);
                                const parsed = jsyaml.load(text);
                                const fields = processYamlToFields(parsed);
                                return fields.filter(f => f.level === 'core');
                            } catch (err) {
                                console.error(`Failed to fetch ${file.name}:`, err);
                                failedCount++;
                                return [];
                            }
                        });
                        
                        const results = await Promise.all(promises);
                        results.forEach(fields => {
                            allCore = [...allCore, ...fields];
                        });
                        setParsedFields([...allCore]);
                    }
                    
                    if (failedCount > 0) setError(`Completed with ${failedCount} errors (rate limit might be reached).`);

                } catch (e) {
                    setError("Global Scan Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
            };

            const toggleExpand = (fieldName) => {
                setExpandedField(expandedField === fieldName ? null : fieldName);
            };

            const filteredFields = parsedFields.filter(f => {
                const matchesSearch = f.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesLevel = filterLevel === 'all' || f.level === filterLevel;
                return matchesSearch && matchesLevel;
            });

            return (
                <div className="flex h-full gap-4">
                    <div className="w-1/4 min-w-[200px] flex flex-col gap-2 bg-slate-800/50 p-2 rounded-xl border border-slate-700">
                        <div className="text-xs font-bold text-slate-400 px-2 py-1 flex justify-between items-center">
                            <span>ECS SCHEMAS</span>
                            <button onClick={fetchFileList} className="hover:text-white" title="Refresh List"><SimpleIcon name="RefreshCw" size={12}/></button>
                        </div>
                        
                        <button 
                            onClick={scanAllCoreFields}
                            className="flex items-center gap-2 w-full text-left text-xs px-3 py-2 rounded bg-emerald-900/30 hover:bg-emerald-800/50 text-emerald-400 border border-emerald-800/50 transition-all mb-2"
                        >
                            <SimpleIcon name="Search" size={12}/> Scan All Core Fields
                        </button>

                        {loading && !files.length && <div className="text-center text-xs text-slate-500 py-4">Loading GitHub...</div>}
                        {error && <div className="text-xs text-red-400 p-2 bg-red-900/20 rounded border border-red-800/50">{error}</div>}
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-1">
                            {files.map(file => (
                                <button 
                                    key={file.path} 
                                    onClick={() => fetchSchemaContent(file)}
                                    className={`w-full text-left text-xs px-2 py-1.5 rounded truncate transition-colors ${selectedFile?.path === file.path ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700 hover:text-slate-200'}`}
                                >
                                    {file.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="flex-1 flex flex-col bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                        {!selectedFile ? (
                            <div className="flex-1 flex items-center justify-center text-slate-500 text-sm italic">
                                Select a schema file to view fields
                            </div>
                        ) : (
                            <>
                                <div className="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-900/30 shrink-0">
                                    <div className="flex items-center gap-3">
                                        <div className="flex items-center gap-2">
                                            <SimpleIcon name="FileText" size={14} className="text-blue-400"/>
                                            <span className="font-bold text-slate-200 text-sm">{selectedFile.name}</span>
                                            <span className="text-xs text-slate-500">({filteredFields.length} shown)</span>
                                        </div>
                                        <div className="flex bg-slate-800 rounded p-0.5 border border-slate-600">
                                            <button 
                                                onClick={() => setFilterLevel('all')} 
                                                className={`px-2 py-0.5 text-[10px] rounded transition-colors ${filterLevel === 'all' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-slate-200'}`}
                                            >
                                                All
                                            </button>
                                            <button 
                                                onClick={() => setFilterLevel('core')} 
                                                className={`px-2 py-0.5 text-[10px] rounded transition-colors flex items-center gap-1 ${filterLevel === 'core' ? 'bg-emerald-700 text-white' : 'text-slate-400 hover:text-slate-200'}`}
                                            >
                                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Core Only
                                            </button>
                                        </div>
                                    </div>
                                    <div className="relative">
                                        <input 
                                            type="text" 
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            placeholder="Search..." 
                                            className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs focus:border-blue-500 outline-none w-40"
                                        />
                                        <div className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"><SimpleIcon name="Search" size={12}/></div>
                                    </div>
                                </div>
                                
                                {loading && parsedFields.length === 0 ? (
                                    <div className="flex-1 flex flex-col items-center justify-center text-slate-500 text-xs gap-2">
                                        <SimpleIcon name="RefreshCw" size={20} className="animate-spin"/>
                                        <span>Parsing YAML / Scanning...</span>
                                    </div>
                                ) : (
                                    <div className="flex-1 overflow-y-auto custom-scrollbar p-0">
                                        <table className="w-full text-left border-collapse relative table-fixed">
                                            <thead className="bg-slate-800 sticky top-0 z-10 text-xs text-slate-400 font-semibold shadow-sm">
                                                <tr>
                                                    <th className="p-2 pl-3 border-b border-slate-700 w-8"></th>
                                                    <th className="p-2 border-b border-slate-700 w-1/4">Field Name</th>
                                                    <th className="p-2 border-b border-slate-700 w-16">Level</th>
                                                    <th className="p-2 border-b border-slate-700 w-20">Type</th>
                                                    <th className="p-2 border-b border-slate-700 w-1/4">Short Desc</th>
                                                    <th className="p-2 border-b border-slate-700">Example</th>
                                                    <th className="p-2 border-b border-slate-700 w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-xs">
                                                {filteredFields.map((field, i) => {
                                                    const isExpanded = expandedField === field.name;
                                                    return (
                                                        <React.Fragment key={i}>
                                                            <tr className={`hover:bg-slate-700/30 transition-colors group border-b border-slate-800/50 cursor-pointer ${isExpanded ? 'bg-slate-800/50' : ''}`} onClick={() => toggleExpand(field.name)}>
                                                                <td className="p-2 text-center text-slate-500">
                                                                    {isExpanded ? <SimpleIcon name="ChevronDown" size={10}/> : <SimpleIcon name="ChevronRight" size={10}/>}
                                                                </td>
                                                                <td className="p-2 text-emerald-300 font-mono break-all">{field.name}</td>
                                                                <td className="p-2">
                                                                    <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${field.level === 'core' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-800' : 'bg-slate-700 text-slate-400'}`}>
                                                                        {field.level}
                                                                    </span>
                                                                </td>
                                                                <td className="p-2 text-purple-300">{field.type}</td>
                                                                <td className="p-2 text-slate-400 truncate" title={field.short}>{field.short}</td>
                                                                <td className="p-2 text-slate-500 italic truncate" title={field.example}>{field.example}</td>
                                                                <td className="p-2 text-right pr-3">
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); copyToClipboard(field.name); }} 
                                                                        className="text-slate-600 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        title="Copy Field Name"
                                                                    >
                                                                        <SimpleIcon name="Copy" size={12}/>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                            {isExpanded && (
                                                                <tr className="bg-slate-900/30">
                                                                    <td colSpan="7" className="p-0">
                                                                        <div className="p-4 border-b border-slate-800 grid gap-4 text-xs animate-fade-in">
                                                                            <div>
                                                                                <h4 className="text-slate-500 font-bold uppercase mb-1 tracking-wider text-[10px]">Description</h4>
                                                                                <div className="text-slate-300 whitespace-pre-wrap leading-relaxed">{field.description || field.short || "No description available."}</div>
                                                                            </div>
                                                                            {field.allowed_values && field.allowed_values.length > 0 && (
                                                                                <div>
                                                                                    <h4 className="text-amber-500 font-bold uppercase mb-1 tracking-wider text-[10px] flex items-center gap-2">Allowed Values <span className="bg-amber-900/30 px-1.5 rounded text-amber-300 text-[9px]">{field.allowed_values.length}</span></h4>
                                                                                    <div className="border border-slate-700 rounded bg-slate-900/50 overflow-hidden">
                                                                                        <table className="w-full">
                                                                                            <thead className="bg-slate-800 text-slate-400 text-left">
                                                                                                <tr>
                                                                                                    <th className="p-2 border-b border-slate-700 w-1/4">Value</th>
                                                                                                    <th className="p-2 border-b border-slate-700">Description</th>
                                                                                                </tr>
                                                                                            </thead>
                                                                                            <tbody>
                                                                                                {field.allowed_values.map((av, idx) => (
                                                                                                    <tr key={idx} className="border-b border-slate-800/50 last:border-0">
                                                                                                        <td className="p-2 font-mono text-amber-200">{av.name}</td>
                                                                                                        <td className="p-2 text-slate-400">{av.description}</td>
                                                                                                    </tr>
                                                                                                ))}
                                                                                            </tbody>
                                                                                        </table>
                                                                                    </div>
                                                                                </div>
                                                                            )}
                                                                            <div className="flex gap-8">
                                                                                {field.normalize && (
                                                                                    <div>
                                                                                        <h4 className="text-blue-400 font-bold uppercase mb-1 tracking-wider text-[10px]">Normalization</h4>
                                                                                        <div className="flex gap-1">
                                                                                            {field.normalize.map((n, idx) => (
                                                                                                <span key={idx} className="px-1.5 py-0.5 bg-blue-900/30 border border-blue-800 text-blue-300 rounded">{n}</span>
                                                                                            ))}
                                                                                        </div>
                                                                                    </div>
                                                                                )}
                                                                                {field.example && (
                                                                                    <div>
                                                                                        <h4 className="text-slate-500 font-bold uppercase mb-1 tracking-wider text-[10px]">Example</h4>
                                                                                        <code className="px-1.5 py-0.5 bg-slate-800 border border-slate-700 rounded text-slate-300">{field.example}</code>
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            )}
                                                        </React.Fragment>
                                                    );
                                                })}
                                                {filteredFields.length === 0 && (
                                                    <tr><td colSpan="7" className="p-8 text-center text-slate-500 italic">No matching fields found</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const defaultInput = ""; 
            const [activeTab, setActiveTab] = useState('builder');
            const [inputStr, setInputStr] = useStickyState(defaultInput, 'jcb_inputStr');
            const [bulkMapStr, setBulkMapStr] = useStickyState("", 'jcb_bulkMapStr');
            const [moduleName, setModuleName] = useStickyState("", 'jcb_moduleName'); 
            const [ignoreStr, setIgnoreStr] = useStickyState("password, v, deprecated_field", 'jcb_ignoreStr');
            const [sortOrder, setSortOrder] = useStickyState('original', 'jcb_sortOrder');
            const [mappings, setMappings] = useStickyState({}, 'jcb_mappings'); 
            const [extraMappings, setExtraMappings] = useStickyState({}, 'jcb_extraMappings'); 
            const [excludedKeys, setExcludedKeys] = useStickyState({}, 'jcb_excludedKeys');
            const [conversions, setConversions] = useStickyState({}, 'jcb_conversions');
            const [expandedPanels, setExpandedPanels] = useState({}); 
            const [historyFields, setHistoryFields] = useStickyMapState('jcb_historyFields');
            const [inputHistory, setInputHistory] = useStickyState([], 'jcb_inputHistory');
            const [draftInput, setDraftInput] = useStickyState({ content: "", title: "" }, 'jcb_draftInput');
            const [viewingId, setViewingId] = useState(null); 
            const [inputTitle, setInputTitle] = useState(""); 
            const [bulkLog, setBulkLog] = useStickyState([], 'jcb_bulkLog');
            const [parsedJson, setParsedJson] = useState(null);
            const [error, setError] = useState(null);
            const [copySuccess, setCopySuccess] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");
            
            // Global ECS Definitions
            const [ecsGlobalDefs, setEcsGlobalDefs] = useState({});
            const [ecsStatus, setEcsStatus] = useState('init'); // init, loading, success, error
            const [loadingOverlay, setLoadingOverlay] = useState(true);
            // Add state for download progress log
            const [downloadLog, setDownloadLog] = useState("");

            const ignoreList = useMemo(() => ignoreStr.split(/[,，\n]+/).map(s => s.trim()).filter(s => s), [ignoreStr]);
            const sampleInput = JSON.stringify({ "_temp": { "username": "peter", "action": "pass", "status": "1", "role": "admin", "deprecated_field": "ignore_me" } }, null, 2);

            // Fetch global ECS flat definition on load with Cache and Overlay
            useEffect(() => {
                const initApp = async () => {
                    // 1. Try Cache
                    const cached = localStorage.getItem('jcb_ecs_global_defs');
                    if (cached) {
                        try {
                            setEcsGlobalDefs(JSON.parse(cached));
                            setEcsStatus('success');
                            setLoadingOverlay(false);
                            return;
                        } catch (e) {
                            console.error("Cache invalid", e);
                            localStorage.removeItem('jcb_ecs_global_defs');
                        }
                    }

                    // 2. Fetch if needed
                    await reloadEcs();
                };
                initApp();
            }, []);

            const reloadEcs = async () => {
                setEcsStatus('loading');
                setLoadingOverlay(true);
                setDownloadLog("Initializing download...");
                
                try {
                    // CDN first - Correct URL for YML file
                    const url = "https://cdn.jsdelivr.net/gh/elastic/ecs@main/generated/ecs/ecs_flat.yml";
                    
                    // Helper to update progress log UI
                    const onProgress = (received, total) => {
                        if (total) {
                            const percent = Math.round((received / total) * 100);
                            const mbReceived = (received / (1024 * 1024)).toFixed(1);
                            const mbTotal = (total / (1024 * 1024)).toFixed(1);
                            setDownloadLog(`Downloading... ${mbReceived} MB / ${mbTotal} MB (${percent}%)`);
                        } else {
                            const mbReceived = (received / (1024 * 1024)).toFixed(1);
                            setDownloadLog(`Downloading... ${mbReceived} MB`);
                        }
                    };

                    const text = await fetchRawFile(url, onProgress, (msg) => setDownloadLog(msg));
                    setDownloadLog("Parsing YAML...");
                    const json = jsyaml.load(text);
                    setEcsGlobalDefs(json);
                    setEcsStatus('success');
                    localStorage.setItem('jcb_ecs_global_defs', JSON.stringify(json));
                    setLoadingOverlay(false);
                } catch(e) {
                    console.warn("Failed to load ECS flat definitions", e);
                    setEcsStatus('error');
                    setDownloadLog(`Error: ${e.message}`);
                    // Don't close overlay automatically on error to show retry options
                }
            };

            const handleSkipLoading = () => {
                setLoadingOverlay(false);
            };

            const handleForceReset = (e) => {
                if (e.altKey) {
                    if(confirm("Clear ECS Cache?")) {
                        localStorage.removeItem('jcb_ecs_global_defs');
                        window.location.reload();
                    }
                } else {
                    if(confirm("Are you sure you want to clear all data and reset?")) {
                        localStorage.clear();
                        window.location.reload();
                    }
                }
            };

            useEffect(() => {
                if (viewingId === null) {
                    if (inputStr === draftInput.content) {
                        setInputTitle(draftInput.title);
                    }
                }
            }, []);

            useEffect(() => {
                if (viewingId === null) {
                    setDraftInput({ content: inputStr, title: inputTitle });
                }
            }, [inputStr, inputTitle, viewingId]);

            useEffect(() => {
                try {
                    if (!inputStr.trim()) { setParsedJson(null); setError(null); return; }
                    const rawParsed = JSON.parse(inputStr);
                    const tempObj = findTempObject(rawParsed);
                    if (tempObj) { setParsedJson(tempObj); setError(null); }
                    else { setParsedJson(null); setError("找不到 '_temp' 物件"); }
                } catch (e) { setError("JSON 格式錯誤"); setParsedJson(null); }
            }, [inputStr]);

            const currentInputKeys = useMemo(() => (!parsedJson ? [] : extractKeys(parsedJson)), [parsedJson]);

            const handleLoadSample = () => {
                setInputStr(sampleInput);
                setInputTitle("Sample Data");
            };

            const mergedKeys = useMemo(() => {
                const keysMap = new Map();
                historyFields.forEach((k, name) => { keysMap.set(name, { ...k, oldValue: k.sampleValue, newValue: undefined, sampleValue: k.sampleValue }); });
                currentInputKeys.forEach(k => {
                    if (keysMap.has(k.name)) {
                        const existing = keysMap.get(k.name);
                        keysMap.set(k.name, { ...existing, newValue: k.sampleValue, sampleValue: k.sampleValue });
                    } else {
                        keysMap.set(k.name, { ...k, oldValue: undefined, newValue: k.sampleValue, sampleValue: k.sampleValue });
                    }
                });
                return Array.from(keysMap.values());
            }, [historyFields, currentInputKeys]);

            const filteredKeys = useMemo(() => {
                const searchLower = searchTerm.toLowerCase();
                const currentPrefix = moduleName.trim() || 'user';
                let keys = mergedKeys.filter(k => {
                    const isIgnored = ignoreList.includes(k.name);
                    if (isIgnored) return false;
                    if (!searchLower) return true;
                    if (k.name.toLowerCase().includes(searchLower)) return true;
                    if (k.fullPath.toLowerCase().includes(searchLower)) return true;
                    const userDefined = mappings[k.name];
                    const effectiveTarget = userDefined !== undefined ? userDefined : `${currentPrefix}.${k.name}`;
                    if (effectiveTarget.toLowerCase().includes(searchLower)) return true;
                    if (extraMappings[k.name] && Array.isArray(extraMappings[k.name])) {
                        if (extraMappings[k.name].some(ex => ex.path && ex.path.toLowerCase().includes(searchLower))) return true;
                    }
                    return false;
                });
                if (sortOrder === 'az') keys.sort((a, b) => a.name.localeCompare(b.name));
                return keys;
            }, [mergedKeys, searchTerm, ignoreList, sortOrder, mappings, moduleName, extraMappings]);

            const outputJson = useMemo(() => {
                const prefix = moduleName.trim() || 'user';
                const directory = [];
                let processKeys = mergedKeys.filter(k => !ignoreList.includes(k.name) && !excludedKeys[k.name]);
                if (sortOrder === 'az') processKeys.sort((a, b) => a.name.localeCompare(b.name));

                processKeys.forEach(k => {
                    const userDefinedTo = mappings[k.name] || "";
                    const defaultTo = `${prefix}.${k.name}`;
                    let primaryConvertData = undefined;
                    if (conversions[k.name] && conversions[k.name].length > 0) {
                        primaryConvertData = {};
                        conversions[k.name].forEach(c => { if (c.from && c.to) primaryConvertData[c.from] = c.to; });
                    }
                    const primaryEntry = { name: k.name, to: userDefinedTo || defaultTo };
                    if (primaryConvertData && Object.keys(primaryConvertData).length > 0) primaryEntry.convert = primaryConvertData;
                    directory.push(primaryEntry);

                    if (extraMappings[k.name] && Array.isArray(extraMappings[k.name])) {
                        extraMappings[k.name].forEach(extraObj => {
                            if (!extraObj) return;
                            const extraEntry = { name: k.name, to: extraObj.path || `${prefix}.${k.name}_copy` };
                            if (extraObj.conversions && extraObj.conversions.length > 0) {
                                const extraConvertData = {};
                                extraObj.conversions.forEach(c => { if (c.from && c.to) extraConvertData[c.from] = c.to; });
                                if (Object.keys(extraConvertData).length > 0) extraEntry.convert = extraConvertData;
                            }
                            directory.push(extraEntry);
                        });
                    }
                });
                return JSON.stringify({ module: moduleName, ignore: ignoreList, directory: directory }, null, 2);
            }, [moduleName, ignoreList, mergedKeys, mappings, excludedKeys, conversions, extraMappings, sortOrder]);

            const handleInputNew = () => {
                setHistoryFields(prev => { const newHistory = new Map(prev); currentInputKeys.forEach(k => newHistory.set(k.name, k)); return newHistory; });
                setInputStr("");
            };
            
            const handleSaveAndAdd = () => {
                if (!inputTitle.trim()) { alert("Please enter a Title for this input."); return; }
                const newItem = { id: Date.now(), title: inputTitle, content: inputStr, timestamp: new Date().toLocaleString() };
                setInputHistory(prev => [newItem, ...prev]);
                setHistoryFields(prev => { const newHistory = new Map(prev); currentInputKeys.forEach(k => newHistory.set(k.name, k)); return newHistory; });
                setInputStr(""); setInputTitle(""); setDraftInput({ content: "", title: "" });
            };

            const handleViewModeChange = (e) => {
                const id = e.target.value === "draft" ? null : parseInt(e.target.value);
                setViewingId(id);
                if (id === null) { setInputStr(draftInput.content); setInputTitle(draftInput.title); }
                else { const item = inputHistory.find(i => i.id === id); if (item) { setInputStr(item.content); setInputTitle(item.title); } }
            };

            const handleMappingChange = (keyName, newValue) => {
                const defaultTo = `${(moduleName.trim() || 'user')}.${keyName}`;
                if (newValue === defaultTo) { setMappings(prev => { const next = { ...prev }; delete next[keyName]; return next; }); }
                else { setMappings(prev => ({ ...prev, [keyName]: newValue })); }
            };
            const toggleExclude = (keyName) => setExcludedKeys(prev => ({ ...prev, [keyName]: !prev[keyName] }));
            const togglePanel = (panelId) => setExpandedPanels(prev => ({ ...prev, [panelId]: !prev[panelId] }));
            const handleBulkImport = (value) => setBulkMapStr(value);
            
            const applyBulkImport = () => {
                const rawRows = parseExcelTSV(bulkMapStr);
                const processedRows = [];
                let previousRow = null;

                rawRows.forEach(row => {
                    if (row.length === 0) return;
                    let cells = row.map(c => c.trim());
                    
                    if (cells.length === 1) {
                         const line = cells[0];
                         const noConvertMatch = line.match(/^(\S+)\s+(no\s+convert)\s+(\S+)$/i);
                         if (noConvertMatch) {
                             cells = [noConvertMatch[1], noConvertMatch[2], noConvertMatch[3]];
                         }
                         else if (!line.includes('=>') && !line.startsWith('"')) {
                            const firstSpace = line.indexOf(' ');
                            if (firstSpace > 0) {
                                const keyPart = line.substring(0, firstSpace).trim();
                                const restPart = line.substring(firstSpace).trim();
                                if (restPart.includes('=>') || restPart.startsWith('"')) {
                                    cells = [keyPart, restPart]; // Force split
                                }
                            }
                        }
                    }

                    const looksLikeConversion = cells[0].includes('=>') || cells[0].startsWith('"');
                    const isContinuation = previousRow && looksLikeConversion;

                    if (isContinuation) {
                        if (cells.length === 1) {
                            const spaceTargetMatch = cells[0].match(/(=>.*?)(\s+)([a-zA-Z0-9_@.-]+)$/);
                            if (spaceTargetMatch) {
                                const convPart = cells[0].substring(0, cells[0].lastIndexOf(spaceTargetMatch[3])).trim();
                                const targetPart = spaceTargetMatch[3];
                                cells = [convPart, targetPart];
                            }
                        }

                        if (previousRow.length < 2) previousRow.push("");
                        previousRow[1] = previousRow[1] + "\n" + cells[0];
                        
                        if (cells.length > 1) {
                            if (previousRow.length < 3) {
                                previousRow.push(cells[1]);
                            } else {
                                previousRow[2] = cells[1];
                            }
                        }
                    } else {
                        previousRow = cells;
                        processedRows.push(previousRow);
                    }
                });

                const newMappings = {}; 
                const newConversions = {}; 
                const newExtraMappings = {}; 

                const parseConversions = (convStr) => {
                    if (!convStr || convStr.match(/no\s*convert/i)) return [];
                    const rules = convStr.split('\n');
                    const parsedRules = [];
                    rules.forEach(rule => {
                         const parts = rule.split('=>');
                         if (parts.length === 2) {
                             let from = parts[0].trim();
                             let to = parts[1].trim();
                             from = from.replace(/^"+|"+$/g, '');
                             to = to.replace(/^"+|"+$/g, '');
                             if (from && to) parsedRules.push({ from, to });
                         }
                    });
                    return parsedRules;
                };

                const groupedImports = {};
                
                processedRows.forEach(row => {
                    const key = row[0];
                    if (key.toLowerCase() === "original field" || key.toLowerCase() === "field name") return;

                    let target = "";
                    let convs = [];

                    if (row.length >= 3) {
                        const convStr = row[1];
                        target = row[2];
                        convs = parseConversions(convStr);
                    } else if (row.length === 2) {
                         if (row[1].includes('=>')) {
                             convs = parseConversions(row[1]);
                             target = ""; // Missing target
                         } else {
                             target = row[1];
                         }
                    }

                    if (key) {
                        if (!groupedImports[key]) groupedImports[key] = [];
                        groupedImports[key].push({ target, convs });
                    }
                });

                const changes = [];
                
                Object.keys(groupedImports).forEach(key => {
                    const entries = groupedImports[key];
                    const primary = entries[0];
                    const oldTarget = mappings[key];
                    
                    if (primary.target) {
                        newMappings[key] = primary.target;
                    }
                    
                    if (primary.convs.length > 0) newConversions[key] = primary.convs;
                    else newConversions[key] = []; 

                    if (primary.target) {
                        if (oldTarget !== undefined && oldTarget !== primary.target) {
                            changes.push({ key, from: oldTarget, to: primary.target, type: 'mapping' });
                        } else if (oldTarget === undefined) {
                            changes.push({ key, from: "None", to: primary.target, type: 'new_mapping' });
                        }
                    }

                    if (entries.length > 1) {
                        const validExtras = entries.slice(1).filter(e => e.target).map(e => ({ path: e.target, conversions: e.convs }));
                        
                        if (validExtras.length > 0) {
                            newExtraMappings[key] = validExtras;
                            changes.push({ key, type: 'extra_added', count: validExtras.length });
                        }
                    } else {
                        if (extraMappings[key]) newExtraMappings[key] = []; 
                    }
                });

                setMappings(prev => ({ ...prev, ...newMappings }));
                setConversions(prev => ({ ...prev, ...newConversions }));
                setExtraMappings(prev => ({ ...prev, ...newExtraMappings }));

                if (changes.length > 0) {
                    setBulkLog(prev => [{ id: Date.now(), time: new Date().toLocaleTimeString(), changes }, ...prev]);
                } else {
                    setBulkLog(prev => [{ id: Date.now(), time: new Date().toLocaleTimeString(), type: 'info', message: "No modifications." }, ...prev]);
                }
            };

            const addExtraMapping = (keyName) => setExtraMappings(prev => ({ ...prev, [keyName]: [...(prev[keyName] || []), { path: "", conversions: [] }] }));
            const updateExtraMapping = (keyName, index, value) => setExtraMappings(prev => { const list = [...(prev[keyName] || [])]; if(list[index]) list[index] = {...list[index], path: value}; return { ...prev, [keyName]: list }; });
            const removeExtraMapping = (keyName, index) => setExtraMappings(prev => { const list = [...(prev[keyName] || [])]; list.splice(index, 1); return { ...prev, [keyName]: list }; });
            const addConversion = (keyName, f, t) => { if(!f||!t)return; setConversions(prev => ({ ...prev, [keyName]: [...(prev[keyName] || []), { from: f, to: t }] })); };
            const updateConversion = (keyName, idx, newFrom, newTo) => { setConversions(prev => { const list = [...(prev[keyName] || [])]; if(list[idx]) list[idx] = { from: newFrom, to: newTo }; return { ...prev, [keyName]: list }; }); };
            const removeConversion = (keyName, i) => setConversions(prev => { const list = [...(prev[keyName] || [])]; list.splice(i, 1); return { ...prev, [keyName]: list }; });
            const addExtraConversion = (keyName, eIdx, f, t) => { if(!f||!t)return; setExtraMappings(prev => { const list = [...(prev[keyName] || [])]; const item = {...list[eIdx]}; item.conversions = [...(item.conversions||[]), {from:f, to:t}]; list[eIdx]=item; return {...prev, [keyName]: list}; }); };
            const updateExtraConversion = (keyName, eIdx, cIdx, newFrom, newTo) => { setExtraMappings(prev => { const list = [...(prev[keyName] || [])]; const item = {...list[eIdx]}; if(item.conversions && item.conversions[cIdx]) { const nc = [...item.conversions]; nc[cIdx] = {from: newFrom, to: newTo}; item.conversions = nc; } list[eIdx]=item; return {...prev, [keyName]: list}; }); };
            const removeExtraConversion = (keyName, eIdx, cIdx) => setExtraMappings(prev => { const list = [...(prev[keyName] || [])]; const item = {...list[eIdx]}; if(item.conversions){ const nc = [...item.conversions]; nc.splice(cIdx, 1); item.conversions = nc; } list[eIdx]=item; return {...prev, [keyName]: list}; });
            const handleCopy = () => { navigator.clipboard.writeText(outputJson).then(() => { setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000); }); };

            const isModuleEmpty = !moduleName;
            const isViewingHistory = viewingId !== null;

            if (loadingOverlay) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center gap-4">
                        <div className="text-slate-200 text-lg font-bold flex items-center gap-3">
                            <SimpleIcon name="Globe" size={24} className="text-blue-500" />
                            JSON Mapping Config Builder
                        </div>
                        {ecsStatus === 'loading' && (
                            <div className="flex flex-col items-center gap-4 w-80">
                                <div className="flex items-center gap-2">
                                    <SimpleIcon name="RefreshCw" size={24} className="text-blue-400 animate-spin" />
                                    <div className="text-slate-400 text-xs font-mono">Loading ECS Definitions...</div>
                                </div>
                                {/* Log Area */}
                                <div className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-[10px] font-mono text-slate-500 h-24 overflow-y-auto custom-scrollbar">
                                    {downloadLog || "Starting..."}
                                </div>
                            </div>
                        )}
                        {ecsStatus === 'error' && (
                            <div className="flex flex-col items-center gap-3">
                                <div className="text-red-400 text-sm flex items-center gap-2 bg-red-900/20 px-3 py-2 rounded border border-red-800">
                                    <SimpleIcon name="AlertTriangle" size={16} />
                                    Failed to load ECS Definitions
                                </div>
                                <div className="text-[10px] text-slate-500 max-w-xs text-center mb-2">{downloadLog}</div>
                                <div className="flex gap-2">
                                    <button onClick={() => reloadEcs()} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold transition-colors">
                                        Retry Download
                                    </button>
                                    <button onClick={handleSkipLoading} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition-colors">
                                        Continue Offline (No Type Hints)
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen p-4 gap-4 overflow-hidden relative">
                    <header className="flex items-center justify-between border-b border-slate-700 pb-2 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-blue-600 rounded-lg"><SimpleIcon name="Code" className="text-white" size={20} /></div>
                            <h1 className="text-lg font-bold text-white">JSON Mapping Config Builder</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            {/* ECS Status Indicator */}
                            <div className="flex items-center gap-1.5 text-xs border border-slate-700 bg-slate-800 px-2 py-1 rounded-md" title={ecsStatus === 'success' ? 'ECS Definitions Loaded' : ecsStatus === 'error' ? 'Failed to load ECS Definitions' : 'Loading ECS Definitions...'}>
                                <span className={`w-2 h-2 rounded-full ${ecsStatus === 'success' ? 'bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.6)]' : ecsStatus === 'error' ? 'bg-red-500' : 'bg-amber-500 animate-pulse'}`}></span>
                                <span className="text-slate-400 font-mono">ECS</span>
                            </div>

                            <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                                <button 
                                    onClick={() => setActiveTab('builder')}
                                    className={`px-3 py-1 text-xs rounded-md transition-all flex items-center gap-1 ${activeTab === 'builder' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                    <SimpleIcon name="Database" size={12}/> Builder
                                </button>
                                <button 
                                    onClick={() => setActiveTab('ecs')}
                                    className={`px-3 py-1 text-xs rounded-md transition-all flex items-center gap-1 ${activeTab === 'ecs' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                    <SimpleIcon name="Globe" size={12}/> ECS Library
                                </button>
                                <button 
                                    onClick={() => setActiveTab('coverage')}
                                    className={`px-3 py-1 text-xs rounded-md transition-all flex items-center gap-1 ${activeTab === 'coverage' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                    <SimpleIcon name="ClipboardCheck" size={12}/> Coverage
                                </button>
                            </div>
                            <div className="h-4 w-px bg-slate-700"></div>
                            <div className="text-xs text-slate-500">v5.3 Fix JSX</div>
                            <button onClick={handleForceReset} className="flex items-center gap-1 text-xs bg-red-900/50 hover:bg-red-800 text-red-200 px-2 py-1 rounded border border-red-700/50 transition-colors" title="Click to Reset App. Alt+Click to Clear ECS Cache."><SimpleIcon name="RefreshCw" size={12} /> Reset</button>
                        </div>
                    </header>

                    {activeTab === 'ecs' ? (
                        <EcsLibrary />
                    ) : activeTab === 'coverage' ? (
                        <CoverageChecker 
                            mergedKeys={mergedKeys} 
                            mappings={mappings} 
                            extraMappings={extraMappings} 
                            moduleName={moduleName} 
                            ignoreList={ignoreList} 
                            excludedKeys={excludedKeys}
                        />
                    ) : (
                        <div className="flex flex-1 gap-4 min-h-0">
                            <div className="w-1/5 flex flex-col gap-2 min-w-[200px]">
                                <div className="flex items-center justify-between">
                                    <label className="flex items-center gap-2 text-xs font-semibold text-blue-400"><span className="w-2 h-2 rounded-full bg-blue-400"></span>Input (Contains "_temp")</label>
                                    <div className="flex items-center gap-1">
                                        <select value={viewingId === null ? "draft" : viewingId} onChange={handleViewModeChange} className="w-24 bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-[10px] focus:border-blue-500 outline-none text-slate-300 mr-1">
                                            <option value="draft">Draft</option>
                                            {inputHistory.map(item => <option key={item.id} value={item.id}>{item.title}</option>)}
                                        </select>
                                    </div>
                                </div>
                                {!isViewingHistory && <input type="text" value={inputTitle} onChange={(e) => setInputTitle(e.target.value)} placeholder="Title..." className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs focus:border-blue-500 outline-none mb-1" />}
                                <div className="flex justify-between mb-1">
                                    {!inputStr && !isViewingHistory && <button onClick={handleLoadSample} className="text-[9px] bg-slate-800 hover:bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded border border-slate-600 transition-colors">Sample</button>}
                                    {!isViewingHistory && <button onClick={handleSaveAndAdd} className="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded transition-colors ml-auto"><SimpleIcon name="Save" size={10} /> Save</button>}
                                </div>
                                <div className={`flex-1 relative rounded-xl border transition-colors overflow-hidden ${error?'border-red-500/50 bg-red-900/10':'border-slate-700 bg-slate-800'}`}>
                                    <textarea className={`w-full h-full bg-transparent p-3 font-mono text-xs resize-none focus:outline-none focus:ring-1 focus:ring-blue-500/50 text-slate-400 ${isViewingHistory ? 'cursor-default opacity-80 bg-slate-900/50' : ''}`} value={inputStr} onChange={(e) => setInputStr(e.target.value)} readOnly={isViewingHistory} placeholder='{"_temp": ...}' spellCheck="false" />
                                    {error && <div className="absolute bottom-2 right-2 text-red-400 text-[10px] flex items-center gap-1 bg-slate-900/90 px-2 py-1 rounded border border-red-500/30"><SimpleIcon name="AlertCircle" size={10} />{error}</div>}
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col gap-3 bg-slate-800/50 p-4 rounded-xl border border-slate-700 shadow-xl min-w-0">
                                <div className="flex items-center justify-between shrink-0">
                                    <div className="flex items-center gap-2 text-sm font-semibold text-purple-400"><SimpleIcon name="Settings" size={16} /> Mapping Config</div>
                                    <div className="flex items-center gap-2 relative">
                                        <div className="flex bg-slate-900 rounded p-0.5 border border-slate-600">
                                            <button onClick={() => setSortOrder('original')} className={`p-1.5 rounded ${sortOrder==='original'?'bg-slate-700 text-white':'text-slate-500 hover:text-slate-300'}`}><SimpleIcon name="List" size={14}/></button>
                                            <button onClick={() => setSortOrder('az')} className={`p-1.5 rounded ${sortOrder==='az'?'bg-slate-700 text-white':'text-slate-500 hover:text-slate-300'}`}><SimpleIcon name="SortAsc" size={14}/></button>
                                        </div>
                                        <div className="relative">
                                            <input type="text" value={moduleName} onChange={(e) => setModuleName(e.target.value)} className={`bg-slate-900 border rounded px-2 py-1 text-xs focus:outline-none w-48 text-center transition-all ${isModuleEmpty ? 'border-red-500/50 shadow-[0_0_10px_rgba(239,68,68,0.3)] animate-pulse' : 'border-slate-600 focus:border-purple-500'}`} placeholder="e.g. auth, payment"/>
                                            {isModuleEmpty && <div className="absolute left-full top-1/2 -translate-y-1/2 ml-2 whitespace-nowrap bg-red-600 text-white text-[10px] px-2 py-1 rounded shadow-lg flex items-center animate-bounce"><span>👈 Enter Module Name</span></div>}
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-slate-800 rounded p-3 border border-slate-700 shrink-0"><label className="text-xs text-slate-400 block mb-1">Ignore Fields (Comma separated)</label><input type="text" value={ignoreStr} onChange={(e) => setIgnoreStr(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1.5 text-sm focus:border-purple-500 focus:outline-none" placeholder="e.g. password, old_field..." /></div>
                                <div className="relative shrink-0"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"><SimpleIcon name="Search" size={14} /></div><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Filter fields..." className="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm focus:border-purple-500 focus:outline-none" /></div>
                                
                                <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar flex flex-col gap-2">
                                    {mergedKeys.length === 0 ? <div className="text-center py-10 text-slate-500 text-sm italic">Waiting for Input...</div> : filteredKeys.length === 0 ? <div className="text-center py-10 text-slate-500 text-sm italic">All fields hidden by filter.</div> : (
                                        filteredKeys.map((k, idx) => {
                                            const isExcluded = excludedKeys[k.name];
                                            const primaryExpanded = expandedPanels[k.name];
                                            const hasPrimaryConversions = conversions[k.name] && conversions[k.name].length > 0;
                                            const currentPrefix = moduleName.trim() || 'user';
                                            const currentVal = mappings[k.name] !== undefined ? mappings[k.name] : `${currentPrefix}.${k.name}`;
                                            const isSystemDefault = currentVal === `${currentPrefix}.${k.name}`;
                                            const extras = extraMappings[k.name] || [];
                                            const inCurrent = currentInputKeys.some(ck => ck.name === k.name);
                                            const inHistory = historyFields.has(k.name);
                                            let badge = null;
                                            if (inCurrent && inHistory) badge = <span className="bg-amber-500/20 text-amber-300 text-[9px] font-bold px-1.5 py-0.5 rounded flex items-center animate-fade-in">EXIST</span>;
                                            else if (inCurrent && !inHistory) badge = <span className="bg-blue-500/20 text-blue-300 text-[9px] font-bold px-1.5 py-0.5 rounded flex items-center animate-fade-in">NEW</span>;
                                            const hasChange = k.oldValue !== undefined && k.newValue !== undefined && k.oldValue !== k.newValue;
                                            
                                            // Dynamic ECS Type Lookup
                                            const primaryEcsType = ecsGlobalDefs[currentVal]?.type || ECS_NON_KEYWORD_FIELDS[currentVal];
                                            const primaryValid = validateEcsType(k.sampleValue, primaryEcsType);

                                            return (
                                                <div key={`${k.fullPath}-${idx}`} className={`flex flex-col rounded-lg border transition-all ${isExcluded ? 'bg-slate-800/30 border-slate-800 opacity-60' : 'bg-slate-800 border-slate-700 hover:border-purple-500/50'}`}>
                                                    <div className="flex items-center gap-3 p-2 relative">
                                                        <div className="flex-[2] min-w-0 flex flex-col justify-center">
                                                            <div className="flex items-center gap-2"><button onClick={() => toggleExclude(k.name)} className={`transition-colors ${isExcluded?'text-slate-600':'text-purple-400 hover:text-purple-300'}`}>{isExcluded?<SimpleIcon name="EyeOff" size={14}/>:<SimpleIcon name="Eye" size={14}/>}</button><span className={`text-sm font-bold truncate ${isExcluded?'line-through text-slate-500':'text-purple-300'}`} title={k.name}>{k.name}</span>{badge}</div>
                                                            <div className="ml-6 mt-0.5 text-[10px] text-slate-500 truncate font-mono">
                                                                {hasChange ? (
                                                                    <div className="flex items-center gap-1"><span className="line-through opacity-50" title={`Old: ${String(k.oldValue)}`}>{String(k.oldValue).slice(0,15)}{String(k.oldValue).length>15?'...':''}</span><SimpleIcon name="ArrowRight" size={8} className="opacity-50"/><span className="text-emerald-400" title={`New: ${String(k.newValue)}`}>{String(k.newValue).slice(0,20)}{String(k.newValue).length>20?'...':''}</span></div>
                                                                ) : (<span className="opacity-60" title={String(k.sampleValue)}>{String(k.sampleValue).slice(0,35)}{String(k.sampleValue).length>35?'...':''}</span>)}
                                                            </div>
                                                        </div>
                                                        <SimpleIcon name="ArrowRight" size={12} className="text-slate-600 shrink-0" />
                                                        <div className="flex-[3] relative">
                                                            <input type="text" disabled={isExcluded} value={currentVal} onChange={(e) => handleMappingChange(k.name, e.target.value)} className={`w-full bg-slate-900 border rounded pl-2 pr-20 py-1.5 text-sm focus:outline-none transition-colors ${isExcluded?'border-transparent text-slate-600 cursor-not-allowed':`border-slate-600 focus:border-emerald-500 ${isSystemDefault?'text-sky-400':'text-emerald-400'}`}`} placeholder="Target Path" />
                                                            <div className="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1">
                                                                {primaryEcsType && (
                                                                    <div className={`text-[9px] px-1.5 py-0.5 rounded border flex items-center gap-1 cursor-help tooltip-trigger ${!primaryValid ? 'bg-red-500/20 text-red-300 border-red-500/30' : 'bg-amber-500/20 text-amber-300 border-amber-500/30'}`}>
                                                                        <span>ECS: {primaryEcsType}</span>
                                                                        {!primaryValid && <SimpleIcon name="AlertTriangle" size={10} className="text-red-400" />}
                                                                        {!primaryValid && <div className="tooltip-content hidden absolute bottom-full right-0 mb-2 w-48 bg-slate-900 border border-red-500/50 text-red-200 p-2 rounded shadow-xl z-10 text-[10px]">Value <strong>'{String(k.sampleValue).slice(0,10)}'</strong> is not a valid <strong>{primaryEcsType}</strong></div>}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-1">
                                                            <button onClick={() => !isExcluded && addExtraMapping(k.name)} disabled={isExcluded} className={`p-1.5 rounded transition-all text-xs border ${isExcluded?'opacity-30 cursor-not-allowed border-slate-700 text-slate-500':'bg-slate-700 border-slate-600 text-blue-300 hover:bg-blue-600 hover:text-white hover:border-blue-500'}`}><SimpleIcon name="Plus" size={12}/></button>
                                                            <button onClick={() => !isExcluded && togglePanel(k.name)} disabled={isExcluded} className={`p-1.5 rounded transition-all flex items-center gap-1 text-xs border ${hasPrimaryConversions?'bg-amber-900/30 text-amber-400 border-amber-500/50':'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'} ${isExcluded?'opacity-30 cursor-not-allowed':''}`}><SimpleIcon name="Sliders" size={12}/></button>
                                                        </div>
                                                    </div>
                                                    {primaryExpanded && !isExcluded && (<div className="border-t border-slate-700/50 bg-slate-900/40 p-2 animate-fade-in"><ConversionEditor conversions={conversions[k.name]} onAdd={(f, t) => addConversion(k.name, f, t)} onEdit={(idx, f, t) => updateConversion(k.name, idx, f, t)} onRemove={(i) => removeConversion(k.name, i)} placeholderPrefix={`p-${k.name}`} /></div>)}
                                                    {extras.map((extraObj, eIdx) => {
                                                        const extraPanelKey = `${k.name}-extra-${eIdx}`;
                                                        const isExtraExpanded = expandedPanels[extraPanelKey];
                                                        const hasExtraConversions = extraObj.conversions && extraObj.conversions.length > 0;
                                                        const extraEcsType = ecsGlobalDefs[extraObj.path]?.type || ECS_NON_KEYWORD_FIELDS[extraObj.path];
                                                        const extraValid = validateEcsType(k.sampleValue, extraEcsType);
                                                        return (
                                                            <div key={`extra-${eIdx}`}>
                                                                <div className="flex items-center gap-3 p-2 pt-0 relative animate-fade-in">
                                                                    <div className="flex-[2] flex justify-end pr-4"><SimpleIcon name="CornerDownRight" size={14} className="text-slate-600" /></div>
                                                                    <SimpleIcon name="ArrowRight" size={12} className="text-slate-600 shrink-0 opacity-50" />
                                                                    <div className="flex-[3] relative">
                                                                        <input type="text" disabled={isExcluded} value={extraObj.path} onChange={(e) => updateExtraMapping(k.name, eIdx, e.target.value)} className={`w-full bg-slate-900/50 border border-slate-700 rounded pl-2 pr-20 py-1.5 text-sm focus:outline-none transition-colors text-emerald-300 focus:border-emerald-500 placeholder-slate-600`} placeholder={`${currentPrefix}.${k.name}_copy`} />
                                                                        <div className="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-1">
                                                                            {extraEcsType && (
                                                                                <div className={`text-[9px] px-1.5 py-0.5 rounded border flex items-center gap-1 cursor-help tooltip-trigger ${!extraValid ? 'bg-red-500/20 text-red-300 border-red-500/30' : 'bg-amber-500/20 text-amber-300 border-amber-500/30'}`}>
                                                                                    <span>ECS: {extraEcsType}</span>
                                                                                    {!extraValid && <SimpleIcon name="AlertTriangle" size={10} className="text-red-400" />}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex items-center gap-1 w-[60px]"><button onClick={() => togglePanel(extraPanelKey)} className={`p-1.5 rounded transition-all text-xs border ${hasExtraConversions?'bg-amber-900/30 text-amber-400 border-amber-500/50':'text-slate-500 hover:text-slate-300 border-transparent hover:border-slate-600'}`}><SimpleIcon name="Sliders" size={12}/></button><button onClick={() => removeExtraMapping(k.name, eIdx)} className="p-1.5 text-slate-500 hover:text-red-400 transition-colors"><SimpleIcon name="Trash" size={12}/></button></div>
                                                                </div>
                                                                {isExtraExpanded && (<div className="border-t border-slate-700/50 bg-slate-900/40 p-2 animate-fade-in"><ConversionEditor conversions={extraObj.conversions} onAdd={(f, t) => addExtraConversion(k.name, eIdx, f, t)} onEdit={(idx, f, t) => updateExtraConversion(k.name, eIdx, idx, f, t)} onRemove={(i) => removeExtraConversion(k.name, eIdx, i)} placeholderPrefix={`e-${k.name}-${eIdx}`} /></div>)}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>

                            <div className="w-1/5 flex flex-col gap-2 min-w-[200px]">
                                <label className="flex items-center gap-2 text-xs font-semibold text-amber-400"><span className="w-2 h-2 rounded-full bg-amber-400"></span>Bulk Import (Excel/TSV)</label>
                                <div className="h-1/2 relative rounded-xl border border-slate-700 bg-slate-800 overflow-hidden">
                                    <textarea className="w-full h-full bg-transparent p-3 font-mono text-xs resize-none focus:outline-none focus:ring-1 focus:ring-amber-500/50 text-slate-400" value={bulkMapStr} onChange={(e) => setBulkMapStr(e.target.value)} placeholder={`Paste Excel columns here...\n\nFormat 1 (Simple):\nField Name{tab}Target Path\n\nFormat 2 (Advanced):\nField Name{tab}Conversion Logic{tab}Target Path\n\nExample:\nact\t""Accept""=>""success""\tevent.action`} spellCheck="false" />
                                    <button onClick={applyBulkImport} className="absolute bottom-2 right-2 p-1.5 bg-amber-600 hover:bg-amber-500 text-white rounded shadow text-[10px] flex items-center gap-1"><SimpleIcon name="Play" size={10} /> Apply</button>
                                </div>
                                <div className="flex-1 flex flex-col overflow-hidden rounded-xl border border-slate-700 bg-slate-800">
                                    <div className="flex items-center justify-between p-2 border-b border-slate-700 bg-slate-800/50"><div className="flex items-center gap-1.5 text-[10px] font-bold text-slate-400"><SimpleIcon name="History" size={12}/> CHANGE LOG</div>{bulkLog.length > 0 && <button onClick={() => setBulkLog([])} className="text-[9px] text-slate-500 hover:text-red-400">Clear</button>}</div>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                                        {bulkLog.length === 0 ? <div className="text-center text-[10px] text-slate-600 py-4 italic">No modifications yet</div> : bulkLog.map(log => (
                                            <div key={log.id} className="text-[10px] border-l-2 border-amber-500 pl-2 bg-amber-500/5 p-1.5 rounded">
                                                <div className="text-slate-500 text-[9px] mb-1 flex justify-between"><span>{log.time}</span>{log.type==='info'?<span className="text-blue-400">Info</span>:<span className="text-amber-500">{log.changes.length} Changes</span>}</div>
                                                {log.type==='info' ? <div className="text-slate-400 italic">{log.message}</div> : log.changes.map((change, idx) => (
                                                    <div key={idx} className="text-slate-300 truncate">
                                                        {change.type === 'mapping' && <span><span className="font-mono text-amber-400">{change.key}</span>: <span className="line-through opacity-50">{change.from}</span> &rarr; <span className="text-emerald-400">{change.to}</span></span>}
                                                        {change.type === 'new_mapping' && <span><span className="text-emerald-400">[NEW]</span> {change.key} &rarr; {change.to}</span>}
                                                        {change.type === 'extra_added' && <span><span className="text-blue-400">[EXTRA]</span> {change.key} (+{change.count})</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="h-1/4 min-h-[150px] flex flex-col gap-2 shrink-0">
                        <div className="flex items-center justify-between"><label className="flex items-center gap-2 text-sm font-semibold text-emerald-400"><span className="w-2 h-2 rounded-full bg-emerald-400"></span>Output Config (Real-time)</label><button onClick={handleCopy} className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded transition-colors font-medium ${copySuccess ? 'bg-emerald-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>{copySuccess ? <SimpleIcon name="Check" size={12} /> : <SimpleIcon name="Copy" size={12} />}{copySuccess ? 'Copied!' : 'Copy JSON'}</button></div>
                        <div className="flex-1 rounded-xl border border-slate-700 bg-slate-950 overflow-hidden relative shadow-inner"><textarea readOnly className="w-full h-full bg-transparent p-4 font-mono text-xs md:text-sm resize-none text-emerald-50 focus:outline-none" value={outputJson} /></div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
