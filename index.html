import React, { useState, useMemo, useEffect } from 'react';
import type { ChangeEvent } from 'react';

import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  GoogleAuthProvider, 
  signOut, 
  signInAnonymously, 
  signInWithPopup, 
  signInWithRedirect, 
  getRedirectResult,
  setPersistence,
  browserLocalPersistence
} from 'firebase/auth';
import type { User as FirebaseUser } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from 'firebase/firestore';

// --- Global Declarations ---
declare global {
  var __firebase_config: string | undefined;
  var __app_id: string | undefined;
  var __initial_auth_token: string | undefined;
}

// --- Firebase Config Setup ---
const getFirebaseConfig = () => {
  try {
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
      return JSON.parse(__firebase_config);
    }
  } catch (e) {}

  return {
    apiKey: "AIzaSyCAXIn0MoSh_DMH2ixX3DkRBwadRtvfjtc",
    authDomain: "expense-splitter-4b1ed.firebaseapp.com",
    projectId: "expense-splitter-4b1ed",
    storageBucket: "expense-splitter-4b1ed.firebasestorage.app",
    messagingSenderId: "161709592392",
    appId: "1:161709592392:web:46b9add3ede9d166d66d7d",
    measurementId: "G-XR4QLM1WPZ"
  };
};

// --- Settings ---
const APP_ID_FIXED = 'expense-splitter'; 
const DEFAULT_PAIRING_ID = 'unBXa8QdpPO4oG7ST36mbBBt3Wg2';
const ALLOWED_EMAILS: string[] = []; 

// Initialize Firebase
const firebaseConfig = getFirebaseConfig();
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Interfaces ---
interface Transaction {
  id: string;
  date: string;
  description: string;
  cardholder: string;
  isHerCard: boolean;
  amount: number;
  type: 'me' | 'her' | 'split' | 'gift';
  source: 'amex' | 'other';
}

interface RoomData {
  months: string[]; 
  [key: string]: any; 
}

interface IconProps extends React.SVGProps<SVGSVGElement> { size?: number | string; className?: string; }

// --- Icons ---
const IconWrapper: React.FC<IconProps & { children: React.ReactNode }> = ({ children, size = 24, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
const Upload = (p: IconProps) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>;
const Calculator = (p: IconProps) => <IconWrapper {...p}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>;
const Trash2 = (p: IconProps) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>;
const Printer = (p: IconProps) => <IconWrapper {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconWrapper>;
const FileSpreadsheet = (p: IconProps) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconWrapper>;
const Save = (p: IconProps) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
const Plus = (p: IconProps) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;
const Calendar = (p: IconProps) => <IconWrapper {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconWrapper>;
const Clipboard = (p: IconProps) => <IconWrapper {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconWrapper>;
const Plane = (p: IconProps) => <IconWrapper {...p}><path d="M2 12h20"/><path d="M13 2l3.5 10h-7L13 2z"/><path d="M13 22l-3.5-10h7L13 22z"/><path d="M2 12l5-8"/><path d="M22 12l-5 8"/></IconWrapper>;
const ShoppingBag = (p: IconProps) => <IconWrapper {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></IconWrapper>;
const AlertTriangle = (p: IconProps) => <IconWrapper {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
const ArrowUp = (p: IconProps) => <IconWrapper {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconWrapper>;
const ArrowDown = (p: IconProps) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconWrapper>;
const CheckCircle = (p: IconProps) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
const CloudCheck = (p: IconProps) => <IconWrapper {...p}><path d="M12 21a9 9 0 0 1 0-18c1.05 0 2.05.18 3 .5"/><path d="M9 10a1 1 0 0 1 1-1"/><path d="M14.31 8a2 2 0 0 0-2-2 3 3 0 0 0-3 3"/><path d="M20 12h-2"/><path d="M22 16h-4"/><path d="M16 21l2 2 4-4"/></IconWrapper>; 
const Loader2 = (p: IconProps) => <IconWrapper {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite" /></IconWrapper>;
const LinkIcon = (p: IconProps) => <IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconWrapper>;
const LogOut = (p: IconProps) => <IconWrapper {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconWrapper>;
const UserIcon = (p: IconProps) => <IconWrapper {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
const Menu = (p: IconProps) => <IconWrapper {...p}><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></IconWrapper>;
const X = (p: IconProps) => <IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>;
const RefreshCw = (p: IconProps) => <IconWrapper {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconWrapper>;

// --- Constants ---
const SPLIT_KEYWORDS = ['HKEXPRESS', 'TRIP.COM', 'AGODA', 'AIRBNB', 'HOTEL', 'AIRLINE', 'TOYOKO', 'MARINWORLD', 'BOOKING.COM', 'KLOOK', 'PEACH', 'ANA', 'JAL', 'RYANAIR', 'EASYJET'];
const HER_KEYWORDS = ['MACAUPASS'];
const IGNORE_KEYWORDS = ['PAYMENT', '繳費', 'AUTOPAY', 'FPS', 'FUND TRANSFER', 'THANK YOU', 'REBATE'];
const STORAGE_KEY_PREFIX = 'expense_splitter_';
const STORAGE_KEY_MONTHS = 'expense_splitter_months';
const STORAGE_KEY_PAIRING = 'expense_splitter_pairing_id';

const TYPE_OPTIONS = [
    { id: 'me', label: 'M', className: 'bg-slate-100 text-slate-600 border-slate-200' },
    { id: 'split', label: 'AA', className: 'bg-cyan-100 text-cyan-700 border-cyan-200' },
    { id: 'her', label: 'H', className: 'bg-pink-100 text-pink-600 border-pink-200' },
    { id: 'gift', label: 'G', className: 'bg-purple-100 text-purple-600 border-purple-200' }
] as const;

// --- Helpers ---
const generateId = () => Math.random().toString(36).substr(2, 9);

const splitCsvLine = (line: string): string[] => {
  const result: string[] = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') { current += '"'; i++; } 
      else { inQuotes = !inQuotes; }
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim()); current = '';
    } else { current += char; }
  }
  result.push(current.trim());
  return result;
};

const formatDateStandard = (dateStr: string): string => {
  if (!dateStr) return '';
  const parts = dateStr.split('/');
  if (parts.length === 3) {
     const [p1, p2, p3] = parts;
     if (p3.length === 4) return `${p3}/${p1.padStart(2, '0')}/${p2.padStart(2, '0')}`;
     if (p1.length === 4) return `${p1}/${p2.padStart(2, '0')}/${p3.padStart(2, '0')}`;
  }
  return dateStr;
};

const parseAmexCSV = (csvText: string): Transaction[] => {
  const lines = csvText.split('\n').filter(line => line.trim() !== '');
  const headers = splitCsvLine(lines[0]);
  const dateIdx = headers.findIndex(h => h.includes('日期'));
  const descIdx = headers.findIndex(h => h.includes('描述'));
  const holderIdx = headers.findIndex(h => h.includes('卡会员') || h.includes('卡會員'));
  const amountIdx = headers.findIndex(h => h.includes('金額'));

  if (amountIdx === -1) return [];

  return lines.slice(1).map((line): Transaction | null => {
    const cleanCols = splitCsvLine(line);
    if (cleanCols.length < headers.length) return null;

    const description = cleanCols[descIdx] || '';
    if (IGNORE_KEYWORDS.some(k => description.toUpperCase().includes(k))) return null;

    const cardholder = cleanCols[holderIdx] || '';
    const amount = parseFloat(cleanCols[amountIdx]);
    const rawDate = cleanCols[dateIdx] || '';
    const date = formatDateStandard(rawDate);

    if (isNaN(amount)) return null;

    let type: Transaction['type'] = 'me';
    const descUpper = description.toUpperCase();

    // MACAUPASS Logic: Only 500 is Her, else Me
    if (descUpper.includes('MACAUPASS')) {
        type = amount === 500 ? 'her' : 'me';
    }
    else if (SPLIT_KEYWORDS.some(k => descUpper.includes(k))) {
        type = 'split';
    }
    else if (cardholder.toUpperCase().includes('PUI IENG')) {
        type = 'her';
    }

    return {
      id: generateId(),
      date,
      description,
      cardholder: cardholder.includes('CHAN') ? 'MAIN' : 'SUB',
      isHerCard: cardholder.toUpperCase().includes('PUI IENG'),
      amount,
      type,
      source: 'amex'
    };
  }).filter((t): t is Transaction => t !== null);
};

const parseTextBill = (text: string, year: string): Transaction[] => {
  const lines = text.split('\n').filter(line => line.trim() !== '');
  const monthMap: {[key: string]: string} = {
    'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
    'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
  };

  return lines.map((line): Transaction | null => {
    const trimmed = line.trim();
    const parts = trimmed.split(/\s+/);
    if (parts.length < 4) return null;

    const isCredit = parts[parts.length - 1] === 'CR';
    const amountIndex = isCredit ? parts.length - 2 : parts.length - 1;
    const amountStr = parts[amountIndex].replace(/,/g, '');
    const amount = parseFloat(amountStr);
    if (isNaN(amount)) return null;

    const datePart = parts[0]; 
    const [day, monthStr] = datePart.split('-');
    const month = monthMap[monthStr?.toUpperCase()];
    if (!month) return null;
    const formattedDate = formatDateStandard(`${year}/${month}/${day}`);
    const description = parts.slice(2, amountIndex).join(' ');
    
    if (IGNORE_KEYWORDS.some(k => description.toUpperCase().includes(k))) return null;

    let type: Transaction['type'] = 'me';
    const descUpper = description.toUpperCase();

    // MACAUPASS Logic for Text
    if (descUpper.includes('MACAUPASS')) {
        type = amount === 500 ? 'her' : 'me';
    }
    else if (SPLIT_KEYWORDS.some(k => descUpper.includes(k))) {
        type = 'split';
    }
    
    return {
      id: generateId(),
      date: formattedDate,
      description,
      cardholder: 'OTHER', 
      isHerCard: false,
      amount: isCredit ? -amount : amount, 
      type,
      source: 'other'
    };
  }).filter((t): t is Transaction => t !== null && t.amount > 0);
};

// --- Main Component ---
const ExpenseSplitter: React.FC = () => {
  const [user, setUser] = useState<FirebaseUser | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [currentMonth, setCurrentMonth] = useState<string>('');
  const [availableMonths, setAvailableMonths] = useState<string[]>([]);
  const [filterCardholder, setFilterCardholder] = useState<'all' | 'me' | 'her'>('all');
  const [showTextModal, setShowTextModal] = useState(false);
  const [textInput, setTextInput] = useState('');
  const [statusMsg, setStatusMsg] = useState('');
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [cloudEnabled, setCloudEnabled] = useState(false);
  const [isAuthChecking, setIsAuthChecking] = useState(true);
  const [authError, setAuthError] = useState('');
  const [isPermissionError, setIsPermissionError] = useState(false);
  const [showRedirectLogin, setShowRedirectLogin] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const [pairingId, setPairingId] = useState(localStorage.getItem(STORAGE_KEY_PAIRING) || DEFAULT_PAIRING_ID);
  const [cloudData, setCloudData] = useState<RoomData | null>(null);
  const [showDetailSummary, setShowDetailSummary] = useState(false); // Toggle for details

  // UI Modals
  const [showMonthModal, setShowMonthModal] = useState(false);
  const [newMonthInput, setNewMonthInput] = useState('');
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [showPairingModal, setShowPairingModal] = useState(false);
  const [newPairingInput, setNewPairingInput] = useState('');
  const [sortConfig, setSortConfig] = useState<{ key: keyof Transaction | ''; direction: 'asc' | 'desc' }>({ key: 'date', direction: 'desc' });

  // --- Auth & Init ---
  useEffect(() => {
    setPersistence(auth, browserLocalPersistence).catch(console.error);
    const isDemoKey = firebaseConfig.apiKey?.includes("YOUR_API_KEY") || firebaseConfig.apiKey === "DEMO";
    if (isDemoKey) {
      setCloudEnabled(false);
      loadLocalMonths();
      setIsAuthChecking(false);
    } else {
      getRedirectResult(auth).catch((error) => {
          console.error("Redirect Error:", error);
          setAuthError(error.message);
      });
      const unsubscribe = onAuthStateChanged(auth, (u) => {
        if (u) {
          if (ALLOWED_EMAILS.length === 0 || (u.email && ALLOWED_EMAILS.includes(u.email)) || u.isAnonymous) {
             setUser(u);
             setCloudEnabled(true);
             setAuthError('');
             if (pairingId) loadCloudRoom(pairingId);
             else setIsAuthChecking(false);
          } else {
             signOut(auth);
             setUser(null);
             setCloudEnabled(false);
             setAuthError(`權限不足: ${u.email}`);
             setIsAuthChecking(false);
          }
        } else {
          setUser(null);
          setCloudEnabled(false);
          setIsAuthChecking(false);
        }
      });
      return () => unsubscribe();
    }
  }, []);

  const handleLogin = async () => {
    setAuthError('');
    setIsAuthChecking(true);
    setShowRedirectLogin(false);
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
    } catch (error: any) {
      console.error(error);
      setIsAuthChecking(false);
      if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/popup-blocked') {
          setAuthError("彈出視窗被關閉或阻擋。請嘗試使用下方的「跳轉模式」。");
          setShowRedirectLogin(true);
      } else {
          setAuthError(error.message || "Login failed");
      }
    }
  };

  const handleLoginRedirect = async () => {
      setAuthError('');
      setIsAuthChecking(true);
      try {
          await signInWithRedirect(auth, new GoogleAuthProvider());
      } catch (e: any) {
          setAuthError(e.message);
          setIsAuthChecking(false);
      }
  };

  const handleGuestLogin = async () => {
      setAuthError('');
      setIsAuthChecking(true);
      try {
          await signInAnonymously(auth);
      } catch (error: any) {
          setAuthError(error.message || "Guest login failed");
          setIsAuthChecking(false);
      }
  };

  const handleLogout = async () => {
    await signOut(auth);
    setTransactions([]);
    setAvailableMonths([]);
    setCurrentMonth('');
    setIsMobileMenuOpen(false);
  };

  // --- Data Loading ---
  const getRoomRef = (pid: string) => {
    const isDemoConfig = firebaseConfig.apiKey === "DEMO";
    if (!isDemoConfig) return doc(db, 'expense_rooms', pid);
    return doc(db, 'artifacts', APP_ID_FIXED, 'public', 'data', 'shared_rooms', pid);
  };

  const loadLocalMonths = () => {
    const storedMonths = localStorage.getItem(STORAGE_KEY_MONTHS);
    if (storedMonths) {
      const months = JSON.parse(storedMonths);
      setAvailableMonths(months);
      if (months.length > 0 && !currentMonth) setCurrentMonth(months[0]);
    } else {
      const now = new Date();
      const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      setAvailableMonths([defaultMonth]);
      if (!currentMonth) setCurrentMonth(defaultMonth);
    }
  };

  const loadCloudRoom = async (pid: string) => {
    setIsPermissionError(false);
    try {
      const docRef = getRoomRef(pid);
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data() as RoomData;
          setCloudData(data);
          const months = data.months || [];
          setAvailableMonths(months);
          if ((!currentMonth || !months.includes(currentMonth)) && months.length > 0) {
              setCurrentMonth(months[0]);
          }
          if (currentMonth) {
              setTransactions(data[`data_${currentMonth}`] || []);
          }
        } else {
          setAvailableMonths([]);
          setTransactions([]);
          const def = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
          setCurrentMonth(def);
        }
        setIsAuthChecking(false);
      }, (err) => {
          if (err.code === 'permission-denied') {
             setIsPermissionError(true);
             setAuthError("讀取權限不足 (Permission Denied)。");
          }
          setIsAuthChecking(false);
      });
      return unsubscribe;
    } catch (e) {
      console.error(e);
      setIsAuthChecking(false);
    }
  };

  useEffect(() => {
      if (!currentMonth) return;
      if (cloudEnabled && cloudData) {
          const txns = cloudData[`data_${currentMonth}`] || [];
          setTransactions(txns);
      } else if (!cloudEnabled && !user) {
          const data = localStorage.getItem(STORAGE_KEY_PREFIX + currentMonth);
          if (data) setTransactions(JSON.parse(data));
          else setTransactions([]);
      }
      setHasUnsavedChanges(false);
  }, [currentMonth, cloudData, cloudEnabled, user]);

  const saveChanges = async () => {
    if (!currentMonth) return;
    setStatusMsg('儲存中...');
    try {
      if (cloudEnabled && user) {
        const docRef = getRoomRef(pairingId);
        const updateData: any = {
            [`data_${currentMonth}`]: transactions,
            lastUpdated: new Date().toISOString()
        };
        if (!availableMonths.includes(currentMonth)) {
            const newMonths = [currentMonth, ...availableMonths].sort().reverse();
            setAvailableMonths(newMonths); 
            updateData.months = newMonths;
        }
        await setDoc(docRef, updateData, { merge: true });
      } else {
        localStorage.setItem(STORAGE_KEY_PREFIX + currentMonth, JSON.stringify(transactions));
      }
      setHasUnsavedChanges(false);
      setStatusMsg('已儲存');
      setTimeout(() => setStatusMsg(''), 2000);
    } catch (e) { console.error(e); setStatusMsg('失敗'); }
  };

  const saveImmediate = async (month: string, txns: Transaction[]) => {
    setTransactions(txns);
    try {
      if (cloudEnabled && user) {
        const docRef = getRoomRef(pairingId);
        const updateData: any = { [`data_${month}`]: txns, lastUpdated: new Date().toISOString() };
        if (!availableMonths.includes(month)) {
            const newMonths = [month, ...availableMonths].sort().reverse();
            updateData.months = newMonths;
        }
        await setDoc(docRef, updateData, { merge: true });
      } else {
        localStorage.setItem(STORAGE_KEY_PREFIX + month, JSON.stringify(txns));
      }
      setHasUnsavedChanges(false);
      setStatusMsg('已匯入');
      setTimeout(() => setStatusMsg(''), 2000);
    } catch(e) {}
  };

  // UI Handlers
  const confirmPairingId = () => {
    const pid = newPairingInput.trim();
    setPairingId(pid);
    localStorage.setItem(STORAGE_KEY_PAIRING, pid);
    setShowPairingModal(false);
    if (cloudEnabled && user) {
        setIsAuthChecking(true);
        loadCloudRoom(pid);
    }
  };

  const handleAmexUpload = (e: ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const newTxns = parseAmexCSV(ev.target?.result as string);
      saveImmediate(currentMonth, [...transactions, ...newTxns]);
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  const handleTextSubmit = () => {
    if (!textInput) return;
    const year = currentMonth.split('-')[0] || '2025';
    const newTxns = parseTextBill(textInput, year);
    saveImmediate(currentMonth, [...transactions, ...newTxns]);
    setTextInput('');
    setShowTextModal(false);
  };

  const updateType = (id: string, newType: Transaction['type']) => {
    setTransactions(prev => prev.map(t => t.id === id ? { ...t, type: newType } : t));
    setHasUnsavedChanges(true);
  };

  const switchMonth = (m: string) => {
    if (hasUnsavedChanges && confirm('未儲存變更，是否儲存？')) saveChanges();
    setCurrentMonth(m);
    setIsMobileMenuOpen(false);
  };

  const confirmCreateMonth = () => {
    const m = newMonthInput.trim();
    if (m) {
        if (!availableMonths.includes(m)) {
            const newM = [m, ...availableMonths].sort().reverse();
            setAvailableMonths(newM);
            if(!cloudEnabled) localStorage.setItem(STORAGE_KEY_MONTHS, JSON.stringify(newM));
        }
        setCurrentMonth(m);
    }
    setShowMonthModal(false);
    setIsMobileMenuOpen(false);
  };
  const openCreateMonthModal = () => { setNewMonthInput(new Date().toISOString().slice(0, 7)); setShowMonthModal(true); };
  const openDeleteModal = () => { if (currentMonth) setShowDeleteModal(true); };
  const confirmDeleteMonth = async () => {
    if (!currentMonth) return;
    if (cloudEnabled && user) {
        const docRef = getRoomRef(pairingId);
        const newMonths = availableMonths.filter(m => m !== currentMonth);
        await setDoc(docRef, { months: newMonths }, { merge: true });
    } else {
        localStorage.removeItem(STORAGE_KEY_PREFIX + currentMonth);
    }
    const newMonths = availableMonths.filter(m => m !== currentMonth);
    setAvailableMonths(newMonths);
    if (!cloudEnabled) localStorage.setItem(STORAGE_KEY_MONTHS, JSON.stringify(newMonths));
    if(newMonths.length > 0) setCurrentMonth(newMonths[0]);
    else {
        const def = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
        setAvailableMonths([def]);
        setCurrentMonth(def);
    }
    setShowDeleteModal(false);
  };
  const handleSort = (key: keyof Transaction) => setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));

  // ... Calcs ...
  const sortedTransactions = useMemo(() => {
    let filtered = transactions;
    if (filterCardholder === 'her') filtered = transactions.filter(t => t.isHerCard);
    if (filterCardholder === 'me') filtered = transactions.filter(t => !t.isHerCard);
    return [...filtered].sort((a, b) => {
        const aVal = a[sortConfig.key as keyof Transaction];
        const bVal = b[sortConfig.key as keyof Transaction];
        if (sortConfig.key === 'date') return sortConfig.direction === 'asc' ? new Date(a.date).getTime() - new Date(b.date).getTime() : new Date(b.date).getTime() - new Date(a.date).getTime();
        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
    });
  }, [transactions, filterCardholder, sortConfig]);

  const summary = useMemo(() => {
    let total = 0, sheOwesMe = 0, myCost = 0;
    let amexTotal = 0;
    let otherNoMP = 0;
    let otherMP = 0;

    transactions.forEach(t => {
      total += t.amount;
      if (t.type === 'her') sheOwesMe += t.amount;
      else if (t.type === 'split') { sheOwesMe += t.amount / 2; myCost += t.amount / 2; }
      else if (t.type === 'me' || t.type === 'gift') myCost += t.amount;

      // 3-Way Breakdown Calculation
      if (t.source === 'amex') {
          amexTotal += t.amount;
      } else if (t.source === 'other') {
          if (t.description.toUpperCase().includes('MACAUPASS')) {
              otherMP += t.amount;
          } else {
              otherNoMP += t.amount;
          }
      }
    });
    return { total, sheOwesMe, myCost, amexTotal, otherNoMP, otherMP };
  }, [transactions]);

  const formatMoney = (n: number, currency: string = 'HKD') => 
      new Intl.NumberFormat('zh-HK', { style: 'currency', currency: currency }).format(n);
  
  const exportCSV = () => {
    const BOM = '\uFEFF'; 
    let csvContent = BOM + "日期,描述,持卡人,金額(HKD),分類,H需付金額(HKD)\n";
    sortedTransactions.forEach(t => {
      let shePays = 0;
      let category = '';
      if (t.type === 'her') { shePays = t.amount; category = 'H Pays'; }
      else if (t.type === 'split') { shePays = t.amount / 2; category = 'AA'; }
      else if (t.type === 'me') { category = 'M Pays'; }
      else if (t.type === 'gift') { category = 'Gift'; }
      const safeDesc = `"${t.description.replace(/"/g, '""')}"`;
      csvContent += `${t.date},${safeDesc},${t.cardholder},${t.amount},${category},${shePays.toFixed(2)}\n`;
    });
    csvContent += `\n,,,Total,,${summary.sheOwesMe.toFixed(2)}\n`;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `分帳報告_${currentMonth}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const SortHeader = ({ label, skey, width }: { label: string, skey: keyof Transaction, width?: string }) => (
    <th className={`p-4 font-bold cursor-pointer hover:bg-slate-100 transition-colors ${width || ''}`} onClick={() => handleSort(skey)}>
        <div className={`flex items-center gap-1 ${skey === 'amount' ? 'justify-end' : skey === 'type' ? 'justify-center' : ''}`}>
            {label}
            {sortConfig.key === skey && <span className="text-blue-500">{sortConfig.direction === 'asc' ? <ArrowUp size={14}/> : <ArrowDown size={14}/>}</span>}
        </div>
    </th>
  );

  if (!user && firebaseConfig.apiKey !== "DEMO") {
      // ... Login Render (Same as before) ...
      return (
          <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-800 p-4">
              <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                  <div className="mb-6 flex justify-center">
                      <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                          <Calculator size={32} />
                      </div>
                  </div>
                  <h1 className="text-2xl font-bold mb-2">Expense Splitter</h1>
                  <p className="text-slate-500 mb-8">請登入以存取共用帳單資料</p>
                  
                  {isPermissionError && (
                      <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-start gap-2 text-left">
                          <AlertTriangle size={16} className="mt-0.5 flex-shrink-0" />
                          <div><p className="font-bold text-sm">權限錯誤</p><p className="text-xs mt-1">請檢查 Firebase Rules</p></div>
                      </div>
                  )}

                  {authError && !isPermissionError && <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2 text-left"><AlertTriangle size={16} />{authError}</div>}

                  {isAuthChecking ? <div className="flex justify-center p-2"><Loader2 className="animate-spin text-blue-500" /></div> : (
                      <div className="space-y-3">
                          <button onClick={handleLogin} className="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl transition-all shadow-sm">
                              <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                              使用 Google 帳號登入
                          </button>
                          {showRedirectLogin && <button onClick={handleLoginRedirect} className="w-full flex items-center justify-center gap-3 bg-blue-50 border border-blue-200 hover:bg-blue-100 text-blue-700 font-bold py-3 px-4 rounded-xl transition-all shadow-sm">使用跳轉模式登入</button>}
                          <div className="relative flex py-1 items-center"><div className="flex-grow border-t border-gray-200"></div><span className="flex-shrink-0 mx-2 text-gray-400 text-xs">或</span><div className="flex-grow border-t border-gray-200"></div></div>
                          <button onClick={handleGuestLogin} className="w-full flex items-center justify-center gap-3 bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-4 rounded-xl transition-all shadow-sm"><UserIcon size={18} />直接使用 (訪客登入)</button>
                          <p className="text-xs text-slate-400 mt-2">訪客登入同樣支援雲端同步 (需使用共用 ID)</p>
                      </div>
                  )}
              </div>
          </div>
      );
  }

  return (
    <div className="flex flex-col md:flex-row min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* Mobile Header */}
      <div className="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
         <div className="flex items-center gap-2">
             <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 -ml-2 text-slate-600"><Menu size={24}/></button>
             <h1 className="font-bold text-lg">{currentMonth}</h1>
             {cloudEnabled ? <CloudCheck size={16} className="text-green-500"/> : <Save size={16} className="text-orange-400"/>}
         </div>
         <div className="flex gap-2">
            {hasUnsavedChanges ? (
                <button onClick={saveChanges} className="bg-green-600 text-white p-2 rounded-full shadow-md"><Save size={20}/></button>
            ) : (
                <div className="bg-slate-100 p-2 rounded-full text-slate-400"><CheckCircle size={20}/></div>
            )}
         </div>
      </div>

      {/* Sidebar (Desktop) / Drawer (Mobile) */}
      <div className={`fixed inset-0 z-40 transform ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 md:relative md:translate-x-0 md:w-72 bg-white border-r border-slate-200 flex flex-col h-full`}>
        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
          <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Calendar className="text-blue-600" size={20}/> 賬單記錄</h2>
          <button onClick={() => setIsMobileMenuOpen(false)} className="md:hidden p-2 text-slate-400"><X size={24}/></button>
        </div>
        
        <div className="p-4 border-b border-slate-100 bg-slate-50">
            <div className="text-xs font-bold text-slate-400 uppercase mb-2">共用設定</div>
            <button onClick={() => { setNewPairingInput(pairingId); setShowPairingModal(true); }} className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs font-bold border ${pairingId ? 'bg-green-50 text-green-700 border-green-200' : 'bg-white text-gray-500 border-gray-200'}`}>
                <span className="flex items-center gap-2"><LinkIcon size={14}/> {pairingId ? `ID: ${pairingId.substring(0,6)}...` : '未設定'}</span>
                <span className="text-[10px] bg-white/50 px-1.5 py-0.5 rounded">設定</span>
            </button>
        </div>

        <div className="flex-1 overflow-y-auto p-2 space-y-1">
          <button onClick={openCreateMonthModal} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-blue-600 bg-blue-50 font-bold hover:bg-blue-100 transition-colors text-sm mb-4 border border-blue-100 shadow-sm">
            <div className="bg-white p-1.5 rounded-lg"><Plus size={16}/></div> 新增月份
          </button>
          
          {availableMonths.map(m => (
            <button key={m} onClick={() => { switchMonth(m); setIsMobileMenuOpen(false); }} className={`w-full text-left px-4 py-3 rounded-xl font-medium transition-all flex justify-between items-center ${currentMonth === m ? 'bg-slate-800 text-white shadow-md' : 'text-slate-600 hover:bg-slate-50'}`}>
              <span>{m}</span>
              {currentMonth === m && <div className="w-2 h-2 bg-green-400 rounded-full"></div>}
            </button>
          ))}
        </div>

        {user && (
            <div className="p-4 border-t border-slate-100">
                <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-red-500 text-sm py-2 transition-colors">
                    <LogOut size={16}/> 登出
                </button>
            </div>
        )}
      </div>

      {/* Main Content */}
      <div className="flex-1 h-screen overflow-hidden flex flex-col bg-slate-50">
        {/* Desktop Header */}
        <div className="hidden md:flex justify-between items-center p-8 pb-4">
            <div>
              <h1 className="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                {currentMonth || '請選擇月份'}
                {cloudEnabled ? (
                    <span className="text-xs font-normal bg-green-100 text-green-700 px-3 py-1.5 rounded-full flex items-center gap-1"><CloudCheck size={14}/> Room: {pairingId.substring(0,8)}...</span>
                ) : <span className="text-xs font-normal bg-orange-100 text-orange-700 px-3 py-1.5 rounded-full flex items-center gap-1"><Save size={14}/> Local Only</span>}
                {statusMsg ? <span className="text-xs font-normal bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full flex items-center gap-1 animate-pulse">{statusMsg}</span> : hasUnsavedChanges ? <button onClick={saveChanges} className="text-xs font-bold bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg transition-all transform hover:-translate-y-0.5"><Save size={14}/> 儲存變更</button> : <span className="text-xs font-normal bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full flex items-center gap-1"><CheckCircle size={14}/> 已儲存</span>}
              </h1>
            </div>
            <div className="flex gap-2">
                <button onClick={openDeleteModal} className="p-2 text-slate-300 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"><Trash2 size={20}/></button>
            </div>
        </div>

        <div className="flex-1 overflow-y-auto p-4 md:p-8 pt-0">
            {/* Summary Cards - Compact Row */}
            {transactions.length > 0 && (
                <div className="mb-6 sticky top-0 md:relative z-10 bg-slate-50 pt-2 pb-2 shadow-sm md:shadow-none md:bg-transparent md:p-0"> 
                    {/* Desktop View */}
                    <div className="hidden md:grid grid-cols-3 gap-4">
                         <div 
                            className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors relative group"
                            onClick={() => setShowDetailSummary(!showDetailSummary)}
                        >
                            {!showDetailSummary ? (
                                <>
                                    <p className="text-xs font-bold text-slate-400 uppercase">總簽賬</p>
                                    <p className="text-2xl font-extrabold text-slate-800 mt-1">{formatMoney(summary.total)}</p>
                                    <p className="text-xs text-slate-400 mt-2">點擊查看分項</p>
                                </>
                            ) : (
                                <div className="flex flex-col justify-center h-full gap-1">
                                    <div className="flex justify-between text-sm text-slate-600"><span>AMEX:</span> <span className="font-bold font-mono">{formatMoney(summary.amexTotal)}</span></div>
                                    <div className="flex justify-between text-sm text-slate-600"><span>Other:</span> <span className="font-bold font-mono text-orange-600">{formatMoney(summary.otherNoMP, 'MOP')}</span></div>
                                    <div className="flex justify-between text-sm text-slate-600"><span>MacauPass:</span> <span className="font-bold font-mono text-orange-600">{formatMoney(summary.otherMP, 'MOP')}</span></div>
                                </div>
                            )}
                        </div>
                        <div className="bg-gradient-to-br from-pink-500 to-rose-500 p-5 rounded-2xl shadow-lg shadow-pink-200 text-white flex flex-col justify-between">
                            <p className="text-xs font-bold text-pink-100 uppercase">H 需付</p>
                            <p className="text-3xl font-extrabold mt-1">{formatMoney(summary.sheOwesMe)}</p>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
                            <p className="text-xs font-bold text-slate-400 uppercase">M 實際支出</p>
                            <p className="text-3xl font-extrabold text-slate-800 mt-1">{formatMoney(summary.myCost)}</p>
                        </div>
                    </div>

                    {/* Mobile View - Compact Row */}
                    <div className="md:hidden bg-white rounded-xl shadow-sm border border-slate-200 p-3 flex flex-col gap-3">
                        <div 
                            className="flex justify-between items-center border-b border-slate-100 pb-2 cursor-pointer"
                            onClick={() => setShowDetailSummary(!showDetailSummary)}
                        >
                             <div>
                                <p className="text-[10px] font-bold text-slate-400 uppercase">總簽賬</p>
                                <p className="text-xl font-extrabold text-slate-800">{formatMoney(summary.total)}</p>
                             </div>
                             {/* Toggle Indicator */}
                             <div className="text-slate-300 text-xs">{showDetailSummary ? '▼' : '▶'} 詳細</div>
                        </div>

                        {/* Expandable Detail Section */}
                        {showDetailSummary && (
                            <div className="grid grid-cols-3 gap-2 text-center bg-slate-50 p-2 rounded-lg mb-2 animate-fade-in">
                                <div>
                                    <p className="text-[9px] text-slate-400">AMEX</p>
                                    <p className="text-xs font-bold text-slate-700">{formatMoney(summary.amexTotal)}</p>
                                </div>
                                <div>
                                    <p className="text-[9px] text-slate-400">Other</p>
                                    <p className="text-xs font-bold text-orange-600">{formatMoney(summary.otherNoMP, 'MOP')}</p>
                                </div>
                                <div>
                                    <p className="text-[9px] text-slate-400">MP</p>
                                    <p className="text-xs font-bold text-orange-600">{formatMoney(summary.otherMP, 'MOP')}</p>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <p className="text-[10px] font-bold text-pink-500 uppercase">H 需付</p>
                                <p className="text-lg font-extrabold text-slate-800">{formatMoney(summary.sheOwesMe)}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-bold text-blue-500 uppercase">M 實際支出</p>
                                <p className="text-lg font-extrabold text-slate-800">{formatMoney(summary.myCost)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Tools - Compact Row for Mobile */}
            <div className="flex gap-2 mb-4 overflow-x-auto pb-2 md:grid md:grid-cols-2 md:gap-3 md:mb-6 md:overflow-visible md:pb-0">
                <label className="flex-1 min-w-[140px] flex flex-col items-center justify-center p-3 bg-white border border-slate-200 border-dashed rounded-xl cursor-pointer hover:border-blue-400 active:scale-95 transition-all">
                    <input type="file" accept=".csv" onChange={handleAmexUpload} className="hidden" />
                    <div className="text-blue-600 mb-1"><Upload size={20}/></div>
                    <span className="text-xs font-bold text-slate-600">匯入 AMEX</span>
                </label>
                <button onClick={() => setShowTextModal(true)} className="flex-1 min-w-[140px] flex flex-col items-center justify-center p-3 bg-white border border-slate-200 border-dashed rounded-xl cursor-pointer hover:border-purple-400 active:scale-95 transition-all">
                    <div className="text-purple-600 mb-1"><Clipboard size={20}/></div>
                    <span className="text-xs font-bold text-slate-600">貼上帳單</span>
                </button>
            </div>

            {/* Transactions List */}
            {transactions.length > 0 ? (
                <div className="space-y-4 pb-24 md:pb-0">
                    {/* Desktop Table */}
                    <div className="hidden md:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="flex justify-between items-center p-4 border-b border-slate-100 bg-slate-50/50">
                             <div className="flex gap-2">
                                <button onClick={() => setFilterCardholder('all')} className={`px-3 py-1 rounded-md text-xs font-bold ${filterCardholder==='all'?'bg-slate-800 text-white':'bg-white border'}`}>All</button>
                                <button onClick={() => setFilterCardholder('me')} className={`px-3 py-1 rounded-md text-xs font-bold ${filterCardholder==='me'?'bg-blue-600 text-white':'bg-white border'}`}>Main</button>
                                <button onClick={() => setFilterCardholder('her')} className={`px-3 py-1 rounded-md text-xs font-bold ${filterCardholder==='her'?'bg-pink-500 text-white':'bg-white border'}`}>Sub</button>
                             </div>
                             <button onClick={exportCSV} className="text-green-600 hover:bg-green-50 p-2 rounded"><FileSpreadsheet size={18}/></button>
                        </div>
                        <table className="w-full text-sm text-left">
                             <thead>
                                <tr className="text-slate-400 border-b border-slate-100">
                                    <SortHeader label="日期" skey="date" width="w-28"/>
                                    <SortHeader label="描述" skey="description"/>
                                    <SortHeader label="金額" skey="amount" width="w-28"/>
                                    <SortHeader label="分類" skey="type" width="w-48"/>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {sortedTransactions.map(t => (
                                    <tr key={t.id} className="hover:bg-slate-50 group">
                                        <td className="p-4 font-mono text-xs text-slate-500">{t.date}</td>
                                        <td className="p-4 font-medium text-slate-700">
                                            <div className="flex items-center gap-2">
                                                {t.description.includes('HOTEL') && <ShoppingBag size={14} className="text-orange-400"/>}
                                                <span className="truncate max-w-xs" title={t.description}>{t.description}</span>
                                            </div>
                                        </td>
                                        <td className="p-4 font-bold text-slate-700">{t.amount.toFixed(2)}</td>
                                        <td className="p-4 text-center">
                                            <div className="flex justify-center gap-1">
                                                {TYPE_OPTIONS.map(o => (
                                                    <button key={o.id} onClick={() => updateType(t.id, o.id)} className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${t.type===o.id ? o.className+' ring-2 ring-offset-1 ring-slate-200' : 'text-slate-300 hover:bg-slate-100'}`}>{o.label}</button>
                                                ))}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Mobile Cards */}
                    <div className="md:hidden space-y-3">
                        {sortedTransactions.map(t => (
                            <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative">
                                <div className="flex justify-between items-start mb-1">
                                    <span className="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-0.5 rounded">{t.date}</span>
                                    <span className={`text-lg font-extrabold ${t.source === 'other' ? 'text-orange-600' : 'text-slate-800'}`}>
                                        {t.source === 'other' ? `MOP ${t.amount.toFixed(2)}` : t.amount.toFixed(2)}
                                    </span>
                                </div>
                                <div className="mb-3 pr-16"> {/* Padding right for type indicator if needed */}
                                    <p className="text-sm font-medium text-slate-700 leading-tight">{t.description}</p>
                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded mt-1 inline-block ${t.cardholder.includes('MAIN') ? 'bg-blue-50 text-blue-600' : t.cardholder.includes('SUB') ? 'bg-pink-50 text-pink-600' : 'bg-gray-100 text-gray-500'}`}>
                                        {t.cardholder.includes('MAIN') ? 'MAIN' : t.cardholder.includes('SUB') ? 'SUB' : 'OTHER'}
                                    </span>
                                </div>
                                
                                {/* Action Buttons - Full Width Grid */}
                                <div className="grid grid-cols-4 gap-2 mt-3 pt-3 border-t border-slate-50">
                                    {TYPE_OPTIONS.map(o => (
                                        <button 
                                            key={o.id} 
                                            onClick={() => updateType(t.id, o.id)} 
                                            className={`py-2 rounded-lg flex items-center justify-center text-xs font-bold transition-all border ${t.type===o.id ? o.className + ' shadow-sm' : 'border-transparent text-slate-300 bg-slate-50'}`}
                                        >
                                            {o.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            ) : (
                <div className="text-center py-20 text-slate-400">
                    <p>此月份暫無資料</p>
                    <p className="text-xs mt-2">請上傳 CSV 或貼上文字賬單</p>
                </div>
            )}
        </div>
      </div>

      {/* Keep modals (Same as before) */}
      {showPairingModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6"><h3 className="text-lg font-bold mb-4">設定共用 ID</h3><input type="text" className="w-full p-3 border rounded-lg mb-4 font-mono" placeholder="輸入 ID..." value={newPairingInput} onChange={e => setNewPairingInput(e.target.value)} /><div className="flex justify-end gap-3"><button onClick={() => setShowPairingModal(false)} className="px-4 py-2 text-slate-500 font-bold">取消</button><button onClick={confirmPairingId} className="px-4 py-2 bg-green-600 text-white rounded-lg font-bold">確定</button></div></div></div>}
      {showTextModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6"><h3 className="text-lg font-bold mb-4">貼上賬單</h3><textarea className="w-full h-64 p-4 border rounded-xl font-mono text-xs bg-slate-50 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="例如: 21-OCT..." value={textInput} onChange={e => setTextInput(e.target.value)} /><div className="flex justify-end gap-3 mt-4"><button onClick={() => setShowTextModal(false)} className="px-4 py-2 text-slate-500 font-bold">取消</button><button onClick={handleTextSubmit} className="px-6 py-2 bg-purple-600 text-white rounded-lg font-bold">確認分析</button></div></div></div>}
      {showMonthModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6"><h3 className="text-lg font-bold mb-4">新增月份</h3><input type="text" className="w-full p-3 border rounded-lg mb-4 font-mono" placeholder="YYYY-MM" value={newMonthInput} onChange={e => setNewMonthInput(e.target.value)} /><div className="flex justify-end gap-3"><button onClick={() => setShowMonthModal(false)} className="px-4 py-2 text-slate-500 font-bold">取消</button><button onClick={confirmCreateMonth} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">確定</button></div></div></div>}
      {showDeleteModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6"><h3 className="text-lg font-bold text-red-600 flex items-center gap-2"><AlertTriangle size={24}/> 刪除確認</h3><p className="text-slate-600 my-4">確定要刪除 <span className="font-bold text-slate-900">{currentMonth}</span> 嗎？</p><div className="flex justify-end gap-3"><button onClick={() => setShowDeleteModal(false)} className="px-4 py-2 text-slate-500 font-bold">取消</button><button onClick={confirmDeleteMonth} className="px-4 py-2 bg-red-600 text-white rounded-lg font-bold">刪除</button></div></div></div>}
    </div>
  );
};

export default ExpenseSplitter;
