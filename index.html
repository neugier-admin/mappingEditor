<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Mapping Config Builder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.8); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }
        textarea:focus, input:focus { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Components (Simple SVGs to avoid dependency issues) ---
        const Icon = ({ path, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        // Fixed: Wrapped multi-element icons in Fragments <>...</>
        const Icons = {
            Code: <path d="m18 16 4-4-4-4M6 8l-4 4 4 4m6-8-4 8"/>,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>,
            ArrowRight: <path d="M5 12h14M12 5l7 7-7 7"/>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            Check: <path d="M20 6 9 17l-5-5"/>,
            Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
            EyeOff: <><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>,
            Sliders: <><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="1" x2="7" y1="14" y2="14"/><line x1="9" x2="15" y1="8" y2="8"/><line x1="17" x2="23" y1="16" y2="16"/></>,
            ArrowRightLeft: <><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></>,
            Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>
        };

        const SimpleIcon = ({ name, size, className }) => (
            <Icon path={Icons[name]} size={size} className={className} />
        );

        // --- Main Application ---
        function App() {
            // Initial Data
            const initialInput = JSON.stringify({
                "_temp": {
                    "username": "peter",
                    "action": "pass",
                    "status": "1",
                    "role": "admin",
                    "deprecated_field": "ignore_me"
                }
            }, null, 2);

            // States
            const [inputStr, setInputStr] = useState(initialInput);
            const [moduleName, setModuleName] = useState("{module.name}");
            const [ignoreStr, setIgnoreStr] = useState("password, v, deprecated_field");
            const [parsedJson, setParsedJson] = useState(null);
            const [error, setError] = useState(null);
            
            // Mappings & Config
            const [mappings, setMappings] = useState({}); 
            const [excludedKeys, setExcludedKeys] = useState({}); // UI Exclude (Eye toggle)
            const [conversions, setConversions] = useState({});
            const [expandedPanels, setExpandedPanels] = useState({});
            
            const [copySuccess, setCopySuccess] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");

            // Parse Ignore List (Common Logic)
            const ignoreList = useMemo(() => {
                return ignoreStr.split(/[,，\n]+/).map(s => s.trim()).filter(s => s);
            }, [ignoreStr]);

            // 1. Listen to input changes & parse JSON
            useEffect(() => {
                try {
                    if (!inputStr.trim()) {
                        setParsedJson(null);
                        setError(null);
                        return;
                    }
                    const parsed = JSON.parse(inputStr);
                    setParsedJson(parsed);
                    setError(null);
                } catch (e) {
                    setError("JSON 格式錯誤");
                    setParsedJson(null);
                }
            }, [inputStr]);

            // 2. Extract Keys recursively
            const extractKeys = (obj, prefix = '') => {
                let keys = [];
                for (const key in obj) {
                    if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                        keys = keys.concat(extractKeys(obj[key], prefix ? `${prefix}.${key}` : key));
                    } else {
                        keys.push({
                            fullPath: prefix ? `${prefix}.${key}` : key,
                            name: key,
                            sampleValue: obj[key]
                        });
                    }
                }
                return keys;
            };

            // 3. Compute current keys
            const currentKeys = useMemo(() => {
                if (!parsedJson) return [];
                return extractKeys(parsedJson);
            }, [parsedJson]);

            // 4. Filter keys for UI
            // Logic: Filter by search AND remove items that are in the Ignore List
            const filteredKeys = useMemo(() => {
                return currentKeys.filter(k => {
                    const matchesSearch = k.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                          k.fullPath.toLowerCase().includes(searchTerm.toLowerCase());
                    const isIgnored = ignoreList.includes(k.name);
                    return matchesSearch && !isIgnored;
                });
            }, [currentKeys, searchTerm, ignoreList]);

            // 5. Generate Output JSON
            const outputJson = useMemo(() => {
                // Determine prefix based on Module Name
                const prefix = moduleName.trim() || 'user';

                // Generate Directory
                // Only include keys that are NOT in the ignoreList AND NOT excluded via UI toggle
                const directory = currentKeys
                    .filter(k => !ignoreList.includes(k.name) && !excludedKeys[k.name]) 
                    .map(k => {
                        const userDefinedTo = mappings[k.name] || "";
                        // Use dynamic prefix
                        const defaultTo = `${prefix}.${k.name}`;
                        
                        const entry = {
                            name: k.name,
                            to: userDefinedTo || defaultTo
                        };

                        if (conversions[k.name] && conversions[k.name].length > 0) {
                            const convertMap = {};
                            conversions[k.name].forEach(c => {
                                if (c.from && c.to) {
                                    convertMap[c.from] = c.to;
                                }
                            });
                            if (Object.keys(convertMap).length > 0) {
                                entry.convert = convertMap;
                            }
                        }
                        return entry;
                    });

                const result = {
                    module: moduleName,
                    ignore: ignoreList,
                    directory: directory
                };

                return JSON.stringify(result, null, 2);
            }, [moduleName, ignoreList, currentKeys, mappings, excludedKeys, conversions]);

            // Handlers
            const handleMappingChange = (keyName, newValue) => {
                setMappings(prev => ({ ...prev, [keyName]: newValue }));
            };

            const toggleExclude = (keyName) => {
                setExcludedKeys(prev => ({ ...prev, [keyName]: !prev[keyName] }));
            };

            const togglePanel = (keyName) => {
                setExpandedPanels(prev => ({ ...prev, [keyName]: !prev[keyName] }));
            };

            const addConversion = (keyName, fromVal, toVal) => {
                if (!fromVal || !toVal) return;
                setConversions(prev => ({
                    ...prev,
                    [keyName]: [...(prev[keyName] || []), { from: fromVal, to: toVal }]
                }));
            };

            const removeConversion = (keyName, index) => {
                setConversions(prev => {
                    const newList = [...(prev[keyName] || [])];
                    newList.splice(index, 1);
                    return { ...prev, [keyName]: newList };
                });
            };

            const handleCopy = () => {
                navigator.clipboard.writeText(outputJson).then(() => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                });
            };

            return (
                <div className="flex flex-col h-screen p-4 gap-4 overflow-hidden">
                    
                    {/* Header */}
                    <header className="flex items-center justify-between border-b border-slate-700 pb-2 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-blue-600 rounded-lg">
                                <SimpleIcon name="Code" className="text-white" size={20} />
                            </div>
                            <h1 className="text-lg font-bold text-white">JSON Mapping Config Builder</h1>
                        </div>
                        <div className="text-xs text-slate-500">v1.2 Standalone</div>
                    </header>

                    {/* Top Section (Split View) */}
                    <div className="flex flex-1 gap-4 min-h-0">
                        
                        {/* LEFT: Input Data (Narrower, less important) */}
                        <div className="w-1/4 flex flex-col gap-2 min-w-[250px]">
                            <label className="flex items-center gap-2 text-xs font-semibold text-blue-400">
                                <span className="w-2 h-2 rounded-full bg-blue-400"></span>
                                Input (_temp JSON)
                            </label>
                            <div className={`flex-1 relative rounded-xl border transition-colors overflow-hidden ${error ? 'border-red-500/50 bg-red-900/10' : 'border-slate-700 bg-slate-800'}`}>
                                <textarea
                                    className="w-full h-full bg-transparent p-3 font-mono text-xs resize-none focus:outline-none focus:ring-1 focus:ring-blue-500/50 text-slate-400"
                                    value={inputStr}
                                    onChange={(e) => setInputStr(e.target.value)}
                                    placeholder='{"_temp": {"key": "val"}}'
                                    spellCheck="false"
                                />
                                {error && (
                                    <div className="absolute bottom-2 right-2 text-red-400 text-[10px] flex items-center gap-1 bg-slate-900/90 px-2 py-1 rounded border border-red-500/30">
                                        <SimpleIcon name="AlertCircle" size={10} />
                                        {error}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* CENTER/RIGHT: Mapping Workspace (Main Focus) */}
                        <div className="flex-1 flex flex-col gap-3 bg-slate-800/50 p-4 rounded-xl border border-slate-700 shadow-xl min-w-0">
                            <div className="flex items-center justify-between shrink-0">
                                <div className="flex items-center gap-2 text-sm font-semibold text-purple-400">
                                    <SimpleIcon name="Settings" size={16} />
                                    Mapping Config (Workspace)
                                </div>
                                
                                {/* Module Name Input */}
                                <input 
                                    type="text" 
                                    value={moduleName}
                                    onChange={(e) => setModuleName(e.target.value)}
                                    className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs focus:border-purple-500 w-48 text-center"
                                    placeholder="Module Name"
                                />
                            </div>

                            {/* Ignore Field Input */}
                            <div className="bg-slate-800 rounded p-3 border border-slate-700 shrink-0">
                                <label className="text-xs text-slate-400 block mb-1">Ignore Fields (Comma separated) - <span className="text-slate-500">Fields added here will be hidden from list below</span></label>
                                <input 
                                    type="text" 
                                    value={ignoreStr}
                                    onChange={(e) => setIgnoreStr(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1.5 text-sm focus:border-purple-500 focus:outline-none"
                                    placeholder="e.g. password, old_field..."
                                />
                            </div>

                            {/* Search */}
                            <div className="relative shrink-0">
                                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
                                    <SimpleIcon name="Search" size={14} />
                                </div>
                                <input 
                                    type="text" 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Filter fields..."
                                    className="w-full bg-slate-900/50 border border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                                />
                            </div>

                            {/* Main List */}
                            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar flex flex-col gap-2">
                                {filteredKeys.length === 0 ? (
                                    <div className="text-center py-10 text-slate-500 text-sm italic">
                                        {currentKeys.length === 0 ? "Waiting for Input..." : "All fields hidden or filtered"}
                                    </div>
                                ) : (
                                    filteredKeys.map((k, idx) => {
                                        const isExcluded = excludedKeys[k.name];
                                        const isExpanded = expandedPanels[k.name];
                                        const hasConversions = conversions[k.name] && conversions[k.name].length > 0;
                                        
                                        // Calculate current default prefix
                                        const currentPrefix = moduleName.trim() || 'user';

                                        return (
                                            <div key={`${k.fullPath}-${idx}`} className={`flex flex-col rounded-lg border transition-all ${isExcluded ? 'bg-slate-800/30 border-slate-800 opacity-60' : 'bg-slate-800 border-slate-700 hover:border-purple-500/50'}`}>
                                                <div className="flex items-center gap-3 p-2">
                                                    
                                                    {/* Field Name & Sample */}
                                                    <div className="flex-[2] min-w-0 flex flex-col justify-center">
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                onClick={() => toggleExclude(k.name)}
                                                                className={`transition-colors ${isExcluded ? 'text-slate-600' : 'text-purple-400 hover:text-purple-300'}`}
                                                                title={isExcluded ? "Include in Directory" : "Exclude from Directory"}
                                                            >
                                                                {isExcluded ? <SimpleIcon name="EyeOff" size={14} /> : <SimpleIcon name="Eye" size={14} />}
                                                            </button>
                                                            <span className={`text-sm font-bold truncate ${isExcluded ? 'line-through text-slate-500' : 'text-purple-300'}`}>{k.name}</span>
                                                        </div>
                                                        <span className="text-[10px] text-slate-500 truncate ml-5">
                                                            Val: <span className="text-slate-400">{String(k.sampleValue)}</span>
                                                        </span>
                                                    </div>

                                                    <SimpleIcon name="ArrowRight" size={12} className="text-slate-600 shrink-0" />

                                                    {/* Target Path Input */}
                                                    <div className="flex-[3]">
                                                        <input 
                                                            type="text"
                                                            disabled={isExcluded}
                                                            // Updated logic: Default is now {moduleName}.{fieldName}
                                                            value={mappings[k.name] !== undefined ? mappings[k.name] : `${currentPrefix}.${k.name}`}
                                                            onChange={(e) => handleMappingChange(k.name, e.target.value)}
                                                            className={`w-full bg-slate-900 border rounded px-2 py-1.5 text-sm focus:outline-none transition-colors ${isExcluded ? 'border-transparent text-slate-600 cursor-not-allowed' : 'border-slate-600 text-emerald-400 focus:border-emerald-500'}`}
                                                            placeholder="Target Path"
                                                        />
                                                    </div>

                                                    {/* Convert Button */}
                                                    <button
                                                        onClick={() => !isExcluded && togglePanel(k.name)}
                                                        disabled={isExcluded}
                                                        className={`px-2 py-1.5 rounded transition-all flex items-center gap-1 text-xs border ${hasConversions ? 'bg-amber-900/30 text-amber-400 border-amber-500/50' : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'} ${isExcluded ? 'opacity-30 cursor-not-allowed' : ''}`}
                                                    >
                                                        <SimpleIcon name="Sliders" size={12} />
                                                        <span className="hidden sm:inline">Convert</span>
                                                    </button>
                                                </div>

                                                {/* Conversion Panel */}
                                                {isExpanded && !isExcluded && (
                                                    <div className="border-t border-slate-700/50 bg-slate-900/40 p-2 animate-in fade-in slide-in-from-top-1 duration-200">
                                                        <div className="space-y-2">
                                                            {conversions[k.name]?.map((c, cIdx) => (
                                                                <div key={cIdx} className="flex items-center gap-2 text-xs">
                                                                    <div className="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-slate-300 text-center">{c.from}</div>
                                                                    <SimpleIcon name="ArrowRight" size={10} className="text-slate-600" />
                                                                    <div className="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-emerald-300 text-center">{c.to}</div>
                                                                    <button onClick={() => removeConversion(k.name, cIdx)} className="text-slate-500 hover:text-red-400"><SimpleIcon name="X" size={12} /></button>
                                                                </div>
                                                            ))}
                                                            
                                                            <div className="flex items-center gap-2 bg-slate-900/50 p-1 rounded border border-slate-700/50">
                                                                <input id={`from-${k.name}`} type="text" placeholder="From" className="flex-1 min-w-0 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs focus:border-amber-500" />
                                                                <SimpleIcon name="ArrowRight" size={10} className="text-slate-500" />
                                                                <input id={`to-${k.name}`} type="text" placeholder="To" className="flex-1 min-w-0 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs focus:border-amber-500" 
                                                                    onKeyDown={(e) => {
                                                                        if (e.key === 'Enter') {
                                                                            const f = document.getElementById(`from-${k.name}`);
                                                                            const t = document.getElementById(`to-${k.name}`);
                                                                            if (f.value && t.value) {
                                                                                addConversion(k.name, f.value, t.value);
                                                                                f.value = ''; t.value = ''; f.focus();
                                                                            }
                                                                        }
                                                                    }}
                                                                />
                                                                <button 
                                                                    onClick={() => {
                                                                        const f = document.getElementById(`from-${k.name}`);
                                                                        const t = document.getElementById(`to-${k.name}`);
                                                                        if (f.value && t.value) {
                                                                            addConversion(k.name, f.value, t.value);
                                                                            f.value = ''; t.value = '';
                                                                        }
                                                                    }}
                                                                    className="p-1 bg-slate-700 hover:bg-amber-600 hover:text-white text-slate-300 rounded"
                                                                >
                                                                    <SimpleIcon name="Plus" size={12} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Bottom Section: Output (Full Width) */}
                    <div className="h-1/4 min-h-[150px] flex flex-col gap-2 shrink-0">
                        <div className="flex items-center justify-between">
                            <label className="flex items-center gap-2 text-sm font-semibold text-emerald-400">
                                <span className="w-2 h-2 rounded-full bg-emerald-400"></span>
                                Output Config (Real-time)
                            </label>
                            <button 
                                onClick={handleCopy}
                                className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded transition-colors font-medium ${copySuccess ? 'bg-emerald-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}
                            >
                                {copySuccess ? <SimpleIcon name="Check" size={12} /> : <SimpleIcon name="Copy" size={12} />}
                                {copySuccess ? 'Copied!' : 'Copy JSON'}
                            </button>
                        </div>
                        
                        <div className="flex-1 rounded-xl border border-slate-700 bg-slate-950 overflow-hidden relative shadow-inner">
                            <textarea
                                readOnly
                                className="w-full h-full bg-transparent p-4 font-mono text-xs md:text-sm resize-none text-emerald-50 focus:outline-none"
                                value={outputJson}
                            />
                        </div>
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
